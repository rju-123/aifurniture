<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Smart Decoration v1.0</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üè†</text></svg>">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Microsoft YaHei', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .header p {
            font-size: 1.2em;
            opacity: 0.9;
        }

        .main-content {
            padding: 40px;
        }

        .step {
            margin-bottom: 40px;
            padding: 30px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            background: #fafafa;
        }

        .step.active {
            border-color: #667eea;
            background: #f8f9ff;
        }

        .step-title {
            font-size: 1.5em;
            color: #333;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
        }

        .step-number {
            background: #667eea;
            color: white;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 15px;
            font-weight: bold;
        }

        .upload-area {
            border: 3px dashed #ccc;
            border-radius: 10px;
            padding: 40px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .upload-area:hover {
            border-color: #667eea;
            background: #f8f9ff;
        }

        .upload-area.dragover {
            border-color: #667eea;
            background: #e8f0fe;
        }

        .furniture-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .furniture-item {
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            padding: 15px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .furniture-item:hover {
            border-color: #667eea;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .furniture-item.selected {
            border-color: #667eea;
            background: #f8f9ff;
        }

        .furniture-item img {
            width: 100%;
            height: 100px;
            object-fit: cover;
            border-radius: 5px;
            margin-bottom: 10px;
        }

        .canvas-container {
            position: relative;
            display: inline-block;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            overflow: hidden;
            margin: 20px 0;
        }

        #drawingCanvas {
            cursor: none; /* Hide default cursor, we will use custom cursor */
        }

        .canvas-cursor {
            position: absolute;
            border: 2px solid rgba(0, 123, 255, 0.8);
            border-radius: 50%;
            pointer-events: none;
            z-index: 10;
            background: rgba(0, 123, 255, 0.2);
            display: none;
        }

        .canvas-tools {
            margin: 20px 0;
            display: flex;
            gap: 15px;
            align-items: center;
            flex-wrap: wrap;
        }

        .tool-group {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .btn {
            background: #667eea;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 25px;
            cursor: pointer;
            font-size: 16px;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-block;
        }

        .btn:hover {
            background: #5a67d8;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }

        .btn:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .btn-secondary {
            background: #6c757d;
        }

        .btn-secondary:hover {
            background: #5a6268;
        }

        .btn-danger {
            background: #dc3545;
        }

        .btn-danger:hover {
            background: #c82333;
        }

        .brush-size {
            margin: 0 10px;
        }

        .brush-size input {
            width: 100px;
        }

        .progress-bar {
            width: 100%;
            height: 20px;
            background: #e0e0e0;
            border-radius: 10px;
            overflow: hidden;
            margin: 20px 0;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(45deg, #667eea, #764ba2);
            width: 0%;
            transition: width 0.3s ease;
        }

        .result-container {
            margin-top: 30px;
            text-align: center;
        }

        .result-image {
            max-width: 100%;
            border-radius: 10px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }

        .loading {
            display: none;
            text-align: center;
            padding: 40px;
        }

        .loading.show {
            display: block;
        }

        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .message {
            padding: 15px;
            border-radius: 5px;
            margin: 20px 0;
            display: none;
        }

        .message.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .message.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .message.show {
            display: block;
        }

        @media (max-width: 768px) {
            .main-content {
                padding: 20px;
            }
            
            .furniture-grid {
                grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
            }
            
            .canvas-tools {
                flex-direction: column;
                align-items: stretch;
            }
            
            .tool-group {
                justify-content: center;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üè† AI Smart Decoration v1.0</h1>
            <p>Upload living room image, select furniture, draw placement area, generate decoration effect image with one click</p>
        </div>

        <div class="main-content">
            <!-- Step 1: Upload Living Room Image -->
            <div class="step active" id="step1">
                <div class="step-title">
                    <div class="step-number">1</div>
                    Upload Living Room Image
                </div>
                <div class="upload-area" id="uploadArea">
                    <div id="uploadContent">
                        <p>üì∑ Click or drag to upload living room image</p>
                        <p style="color: #666; margin-top: 10px;">Supports JPG, PNG, GIF formats, max 16MB</p>
                    </div>
                    <input type="file" id="fileInput" accept="image/*" style="display: none;">
                </div>
                <div id="uploadedImage" style="display: none; text-align: center; margin-top: 20px;">
                    <img id="previewImage" style="max-width: 100%; max-height: 400px; border-radius: 10px;">
                </div>
            </div>

            <!-- Step 2: Identify Living Room Dimensions -->
            <div class="step" id="step2">
                <div class="step-title">
                    <div class="step-number">2</div>
                    Identify Living Room Dimensions
                </div>
                <div id="sizeDetectionArea">
                    <div class="loading" id="sizeLoading" style="display: none;">
                        <div class="spinner"></div>
                        <p>Identifying living room dimensions, please wait...</p>
                    </div>
                    <div id="sizeResult" style="display: none;">
                        <div style="background: #f0f8ff; padding: 20px; border-radius: 10px; margin: 20px 0;">
                            <h4 style="margin-bottom: 15px;">üìè Detected Living Room Dimensions:</h4>
                            <div id="estimatedBadge" style="display: none; background: #fff3cd; padding: 8px 15px; border-radius: 20px; margin-bottom: 15px; text-align: center; color: #856404; font-size: 0.9em;">
                                ‚ö†Ô∏è This is an estimated value based on the image, please confirm or modify
                            </div>
                            <div style="display: flex; gap: 30px; justify-content: center; align-items: center; flex-wrap: wrap;">
                                <div>
                                    <label style="font-weight: bold; color: #667eea;">Length:</label>
                                    <span id="detectedLength" style="font-size: 1.2em; margin-left: 10px;">-</span>
                                    <span style="color: #666;">m</span>
                                </div>
                                <div>
                                    <label style="font-weight: bold; color: #667eea;">Width:</label>
                                    <span id="detectedWidth" style="font-size: 1.2em; margin-left: 10px;">-</span>
                                    <span style="color: #666;">m</span>
                                </div>
                            </div>
                            <div id="sofaSizeRange" style="display: none; margin-top: 20px; padding: 15px; background: #e8f5e9; border-radius: 10px;">
                                <h5 style="margin-bottom: 10px; color: #2e7d32;">üõãÔ∏è Suitable Sofa Size Range:</h5>
                                <div style="display: flex; gap: 30px; justify-content: center; flex-wrap: wrap; font-size: 0.95em;">
                                    <div>
                                        <label style="color: #666;">Length:</label>
                                        <span id="sofaLengthRange" style="font-weight: bold; color: #2e7d32;"></span>
                                        <span style="color: #666;">m</span>
                                    </div>
                                    <div>
                                        <label style="color: #666;">Width:</label>
                                        <span id="sofaWidthRange" style="font-weight: bold; color: #2e7d32;"></span>
                                        <span style="color: #666;">m</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div style="background: #fff3cd; padding: 15px; border-radius: 10px; margin: 20px 0;">
                            <p style="margin: 0; color: #856404;">
                                üí° If the recognition result is inaccurate, you can manually enter the correct dimensions:
                            </p>
                            <div style="display: flex; gap: 20px; margin-top: 15px; justify-content: center; align-items: center; flex-wrap: wrap;">
                                <div>
                                    <label>Length (m):</label>
                                    <input type="number" id="manualLength" step="0.1" min="0" style="padding: 8px; border: 1px solid #ddd; border-radius: 5px; width: 100px;">
                                </div>
                                <div>
                                    <label>Width (m):</label>
                                    <input type="number" id="manualWidth" step="0.1" min="0" style="padding: 8px; border: 1px solid #ddd; border-radius: 5px; width: 100px;">
                                </div>
                                <div>
                                    <button class="btn" id="confirmSizeBtnSuccess" onclick="confirmSizeModify()" style="margin-top: 10px; cursor: pointer;">Confirm Modification</button>
                                </div>
                            </div>
                            <p id="sizeInputErrorSuccess" style="color: #dc3545; margin-top: 10px; display: none; text-align: center;"></p>
                        </div>
                    </div>
                    <div id="sizeError" style="display: none; background: #f8d7da; padding: 15px; border-radius: 10px; color: #721c24;">
                        <p id="sizeErrorMessage"></p>
                        <div style="margin-top: 15px;">
                            <p style="margin-bottom: 10px;">Please manually enter living room dimensions:</p>
                            <div style="display: flex; gap: 20px; justify-content: center; align-items: center; flex-wrap: wrap;">
                                <div>
                                    <label>Length (m):</label>
                                    <input type="number" id="manualLengthError" step="0.1" min="0" style="padding: 8px; border: 1px solid #ddd; border-radius: 5px; width: 100px;">
                                </div>
                                <div>
                                    <label>Width (m):</label>
                                    <input type="number" id="manualWidthError" step="0.1" min="0" style="padding: 8px; border: 1px solid #ddd; border-radius: 5px; width: 100px;">
                                </div>
                                <div>
                                    <button class="btn" id="confirmSizeBtn" onclick="confirmSizeInput()" style="margin-top: 10px; cursor: pointer;">Confirm Dimensions</button>
                                </div>
                            </div>
                            <p id="sizeInputError" style="color: #dc3545; margin-top: 10px; display: none; text-align: center;"></p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Step 3: Select Sofa Style -->
            <div class="step" id="step3">
                <div class="step-title">
                    <div class="step-number">3</div>
                    Select Sofa Style
                </div>
                <div id="styleSelectionArea">
                    <div id="styleButtonsContainer" style="display: flex; gap: 15px; flex-wrap: wrap; justify-content: center; margin: 20px 0;">
                        <button class="btn style-btn" data-style="modern">Modern Style</button>
                        <button class="btn style-btn" data-style="nordic">Nordic Style</button>
                        <button class="btn style-btn" data-style="european">European Style</button>
                        <button class="btn style-btn" data-style="chinese">Chinese Style</button>
                        <button class="btn style-btn" data-style="industrial">Industrial Style</button>
                        <button class="btn style-btn" data-style="minimalist">Minimalist Style</button>
                    </div>
                    <p id="selectedStyleText" style="text-align: center; color: #666; margin-top: 15px; display: none;">
                        Selected Style: <span id="selectedStyleName" style="font-weight: bold; color: #667eea;"></span>
                    </p>
                    <div id="furnitureLoading" style="display: none; text-align: center; margin-top: 20px;">
                        <div class="spinner" style="margin: 0 auto;"></div>
                        <p>Loading sofas...</p>
                    </div>
                </div>
            </div>

            <!-- Step 4: Select Sofa -->
            <div class="step" id="step4">
                <div class="step-title">
                    <div class="step-number">4</div>
                    Select Sofa
                </div>
                <div id="furnitureGrid" class="furniture-grid">
                    <!-- Furniture list will be dynamically loaded via JavaScript -->
                </div>
            </div>

            <!-- Step 5: Erase Furniture -->
            <div class="step" id="step5">
                <div class="step-title">
                    <div class="step-number">5</div>
                    Erase Furniture (Optional)
                </div>
                <div class="canvas-tools">
                    <div class="tool-group">
                        <label>Brush Size: 100px (Fixed)</label>
                    </div>
                    <div class="tool-group">
                        <label>Opacity: 100% (Fixed)</label>
                    </div>
                    <div class="tool-group">
                        <button class="btn btn-secondary" id="eraseUndoBtn">‚Ü∂ Undo</button>
                        <button class="btn btn-danger" id="eraseClearBtn">üóëÔ∏è Clear All</button>
                        <button class="btn" id="startEraseBtn" style="background: #dc3545;">Start Erasing</button>
                        <button class="btn btn-secondary" id="skipEraseBtn" style="background: #6c757d;">Skip Erasing</button>
                    </div>
                </div>
                <div class="canvas-container" id="eraseCanvasContainer" style="display: none;">
                    <canvas id="eraseCanvas"></canvas>
                    <div class="canvas-cursor" id="eraseCanvasCursor"></div>
                </div>
                <p style="color: #666; margin-top: 10px;">
                    üí° Tip: Use the brush tool to draw white areas on the furniture you want to erase. The white areas will be removed and replaced with an empty room background. After erasing, the image will automatically proceed to the drawing step. You can also skip this step if you don't need to erase furniture.
                </p>
                <div class="loading" id="eraseLoading" style="display: none;">
                    <div class="spinner"></div>
                    <p>Erasing furniture, please wait...</p>
                </div>
            </div>

            <!-- Step 6: Draw Placement Area -->
            <div class="step" id="step6">
                <div class="step-title">
                    <div class="step-number">6</div>
                    Draw Furniture Placement Area
                </div>
                <div class="canvas-tools">
                    <div class="tool-group">
                        <label>Brush Size: 100px (Fixed)</label>
                    </div>
                    <div class="tool-group">
                        <label>Opacity: 40% (Fixed)</label>
                    </div>
                    <div class="tool-group">
                        <button class="btn btn-secondary" id="undoBtn">‚Ü∂ Undo</button>
                        <button class="btn btn-danger" id="clearBtn">üóëÔ∏è Clear All</button>
                    </div>
                </div>
                <div class="canvas-container" id="canvasContainer" style="display: none;">
                    <canvas id="drawingCanvas"></canvas>
                    <div class="canvas-cursor" id="canvasCursor"></div>
                </div>
                <p style="color: #666; margin-top: 10px;">
                    üí° Tip: Use the brush tool to draw light blue areas on the living room image to mark the placement of the furniture. The drawn areas should be on the walls of the living room.
                </p>
            </div>

            <!-- Step 7: Generate Effect Image -->
            <div class="step" id="step7">
                <div class="step-title">
                    <div class="step-number">7</div>
                    Generate Decoration Effect Image
                </div>
                <button class="btn" id="generateBtn" disabled>üé® Generate Decoration Effect Image</button>
                
                <div class="loading" id="loading">
                    <div class="spinner"></div>
                    <p>Generating decoration effect image, please wait...</p>
                </div>

                <div class="result-container" id="resultContainer">
                    <!-- Generated results will be displayed here -->
                </div>
            </div>

            <!-- Message Notification -->
            <div class="message" id="message"></div>
        </div>
    </div>

    <script>
        // Global variables
        let uploadedImageFile = null;
        let selectedFurniture = null;
        let canvas = null;
        let ctx = null;
        let isDrawing = false;
        let drawingHistory = [];
        let currentStep = 1;
        let canvasCursor = null;
        let maskCanvas = null; // Temporary canvas for storing mask layer
        let maskCtx = null;
        let roomLength = null; // Living room length (meters)
        let roomWidth = null;  // Living room width (meters)
        let selectedStyle = null; // Selected sofa style
        
        // Erase function related variables
        let eraseCanvas = null;
        let eraseCtx = null;
        let isErasing = false;
        let eraseHistory = [];
        let eraseMaskCanvas = null; // Temporary canvas for storing erase mask
        let eraseMaskCtx = null;
        let eraseCanvasCursor = null;
        let currentTab = 'draw'; // Current tab: 'draw' or 'erase'

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            initializeUpload();
            initializeCanvas();
            initializeButtons();
            initializeStyleSelection();
            initializeSizeButtons();
            initializeEraseCanvas();
        });
        
        // Initialize size confirmation buttons (using event delegation to ensure dynamic elements can respond)
        function initializeSizeButtons() {
            // Use event delegation to listen for click events on the entire document (as a fallback)
            document.addEventListener('click', function(e) {
                // Confirm size button (when recognition fails)
                if (e.target && e.target.id === 'confirmSizeBtn') {
                    e.preventDefault();
                    e.stopPropagation();
                    console.log('Event delegation captured confirm size button click');
                    confirmSizeInput();
                }
                // Confirm modification button (when recognition succeeds)
                if (e.target && e.target.id === 'confirmSizeBtnSuccess') {
                    e.preventDefault();
                    e.stopPropagation();
                    console.log('Event delegation captured confirm modification button click');
                    confirmSizeModify();
                }
            });
            
            // Also try direct binding (if element exists)
            setTimeout(() => {
                const confirmBtn = document.getElementById('confirmSizeBtn');
                const confirmBtnSuccess = document.getElementById('confirmSizeBtnSuccess');
                
                if (confirmBtn) {
                    console.log('Found confirm size button, binding event directly');
                    confirmBtn.addEventListener('click', function(e) {
                        e.preventDefault();
                        e.stopPropagation();
                        console.log('Directly bound event triggered');
                        confirmSizeInput();
                    });
                }
                
                if (confirmBtnSuccess) {
                    console.log('Found confirm modification button, binding event directly');
                    confirmBtnSuccess.addEventListener('click', function(e) {
                        e.preventDefault();
                        e.stopPropagation();
                        console.log('Directly bound event triggered');
                        confirmSizeModify();
                    });
                }
            }, 500);
        }

        // Initialize upload function
        function initializeUpload() {
            const uploadArea = document.getElementById('uploadArea');
            const fileInput = document.getElementById('fileInput');

            uploadArea.addEventListener('click', () => fileInput.click());
            uploadArea.addEventListener('dragover', handleDragOver);
            uploadArea.addEventListener('drop', handleDrop);
            fileInput.addEventListener('change', handleFileSelect);
        }

        function handleDragOver(e) {
            e.preventDefault();
            e.currentTarget.classList.add('dragover');
        }

        function handleDrop(e) {
            e.preventDefault();
            e.currentTarget.classList.remove('dragover');
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                handleFile(files[0]);
            }
        }

        function handleFileSelect(e) {
            const file = e.target.files[0];
            if (file) {
                handleFile(file);
            }
        }

        function handleFile(file) {
            if (!file.type.startsWith('image/')) {
                showMessage('Please select an image file', 'error');
                return;
            }

            // Show preview
            const reader = new FileReader();
            reader.onload = function(e) {
                const previewImage = document.getElementById('previewImage');
                previewImage.src = e.target.result;
                document.getElementById('uploadedImage').style.display = 'block';
                
                // Upload file
                uploadFile(file);
            };
            reader.readAsDataURL(file);
        }

        function uploadFile(file) {
            const formData = new FormData();
            formData.append('file', file);

            // Show upload and recognition status
            const sizeLoading = document.getElementById('sizeLoading');
            if (sizeLoading) {
                sizeLoading.style.display = 'block';
            }

            fetch('/upload', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    uploadedImageFile = data.filename;
                    showMessage('Living room image uploaded successfully, identifying dimensions...', 'success');
                    
                    // Handle size detection results
                    if (data.size_detection) {
                        handleSizeDetection(data.size_detection);
                    } else {
                        // If no size detection results, proceed directly to next step
                        if (sizeLoading) {
                            sizeLoading.style.display = 'none';
                        }
                        activateStep(2);
                    }
                } else {
                    if (sizeLoading) {
                        sizeLoading.style.display = 'none';
                    }
                    showMessage(data.error || 'Upload failed', 'error');
                }
            })
            .catch(error => {
                if (sizeLoading) {
                    sizeLoading.style.display = 'none';
                }
                showMessage('Upload failed: ' + error.message, 'error');
            });
        }

        // Calculate suitable sofa size range (consistent with backend formula)
        function calculateSofaSizeRange(roomLength, roomWidth) {
            // Sofa length: max = room length √ó 0.6, but not exceeding 3.5m
            //              min = room length √ó 0.3, but not less than 1m
            const sofaLengthMax = Math.min(roomLength * 0.6, 3.5);
            const sofaLengthMin = Math.max(roomLength * 0.3, 1.0);
            
            // Sofa width: max = room width √ó 0.3, but not exceeding 1m
            //             min = room width √ó 0.2, but not exceeding 0.7m
            const sofaWidthMax = Math.min(roomWidth * 0.3, 1.0);
            const sofaWidthMin = Math.min(roomWidth * 0.2, 0.7);
            
            return {
                length: {
                    min: parseFloat(sofaLengthMin.toFixed(2)),
                    max: parseFloat(sofaLengthMax.toFixed(2))
                },
                width: {
                    min: parseFloat(sofaWidthMin.toFixed(2)),
                    max: parseFloat(sofaWidthMax.toFixed(2))
                }
            };
        }
        
        // Êõ¥Êñ∞Ê≤ôÂèëÂ∞∫ÂØ∏ËåÉÂõ¥ÊòæÁ§∫
        function updateSofaSizeRangeDisplay(roomLength, roomWidth) {
            const sofaRange = calculateSofaSizeRange(roomLength, roomWidth);
            const sofaSizeRange = document.getElementById('sofaSizeRange');
            const sofaLengthRange = document.getElementById('sofaLengthRange');
            const sofaWidthRange = document.getElementById('sofaWidthRange');
            
            if (sofaSizeRange) {
                sofaSizeRange.style.display = 'block';
            }
            if (sofaLengthRange) {
                sofaLengthRange.textContent = `${sofaRange.length.min} - ${sofaRange.length.max}`;
            }
            if (sofaWidthRange) {
                sofaWidthRange.textContent = `${sofaRange.width.min} - ${sofaRange.width.max}`;
            }
            
            console.log('Sofa size range updated:', sofaRange);
        }

        // Expose function to global scope so onclick can access it
        window.confirmSizeInput = function() {
            console.log('=== confirmSizeInput Ë¢´Ë∞ÉÁî® ===');
            const lengthInput = document.getElementById('manualLengthError');
            const widthInput = document.getElementById('manualWidthError');
            const errorMsg = document.getElementById('sizeInputError');
            
            console.log('lengthInput:', lengthInput);
            console.log('widthInput:', widthInput);
            
            if (!lengthInput || !widthInput) {
                console.error('Êâæ‰∏çÂà∞ËæìÂÖ•Ê°ÜÂÖÉÁ¥†');
                showMessage('System error: Input fields not found', 'error');
                return false;
            }
            
            const length = parseFloat(lengthInput.value);
            const width = parseFloat(widthInput.value);
            
            console.log('Input dimensions - length:', length, 'width:', width);
            console.log('Length value type:', typeof length, 'isNaN:', isNaN(length));
            console.log('Width value type:', typeof width, 'isNaN:', isNaN(width));
            
            // Validate input
            if (!length || length <= 0 || isNaN(length)) {
                console.warn('ÈïøÂ∫¶È™åËØÅÂ§±Ë¥•');
                if (errorMsg) {
                    errorMsg.textContent = 'Please enter a valid length (greater than 0)';
                    errorMsg.style.display = 'block';
                }
                showMessage('Please enter a valid length (greater than 0)', 'error');
                return false;
            }
            if (!width || width <= 0 || isNaN(width)) {
                console.warn('ÂÆΩÂ∫¶È™åËØÅÂ§±Ë¥•');
                if (errorMsg) {
                    errorMsg.textContent = 'Please enter a valid width (greater than 0)';
                    errorMsg.style.display = 'block';
                }
                showMessage('Please enter a valid width (greater than 0)', 'error');
                return false;
            }
            
            // ‰øùÂ≠òÂ∞∫ÂØ∏
            roomLength = length;
            roomWidth = width;
            if (errorMsg) {
                errorMsg.style.display = 'none';
            }
            
            // Êõ¥Êñ∞Ê≤ôÂèëÂ∞∫ÂØ∏ËåÉÂõ¥ÊòæÁ§∫
            updateSofaSizeRangeDisplay(length, width);
            
            console.log('‚úì Dimensions saved - length:', roomLength, 'width:', roomWidth);
            showMessage(`Dimensions confirmed: Length=${length.toFixed(2)}m, Width=${width.toFixed(2)}m`, 'success');
            
            // Ëá™Âä®ËøõÂÖ•‰∏ã‰∏ÄÊ≠•
            setTimeout(() => {
                console.log('ËøõÂÖ•Ê≠•È™§3');
                activateStep(3);
            }, 500);
            
            return false; // Èò≤Ê≠¢Ë°®ÂçïÊèê‰∫§
        };
        
        // ‰øùÁïôÂéüÊù•ÁöÑÂáΩÊï∞ÂÆö‰πâÔºàÂêëÂêéÂÖºÂÆπÔºâ
        function confirmSizeInput() {
            return window.confirmSizeInput();
        }

        // Expose function to global scope
        window.confirmSizeModify = function() {
            console.log('=== confirmSizeModify Ë¢´Ë∞ÉÁî® ===');
            const lengthInput = document.getElementById('manualLength');
            const widthInput = document.getElementById('manualWidth');
            const errorMsg = document.getElementById('sizeInputErrorSuccess');
            
            console.log('lengthInput:', lengthInput);
            console.log('widthInput:', widthInput);
            
            if (!lengthInput || !widthInput) {
                console.error('Êâæ‰∏çÂà∞ËæìÂÖ•Ê°ÜÂÖÉÁ¥†');
                showMessage('System error: Input fields not found', 'error');
                return false;
            }
            
            const length = parseFloat(lengthInput.value);
            const width = parseFloat(widthInput.value);
            
            console.log('ËæìÂÖ•ÁöÑÂ∞∫ÂØ∏ - ÈïøÂ∫¶:', length, 'ÂÆΩÂ∫¶:', width);
            
            // Validate input
            if (!length || length <= 0 || isNaN(length)) {
                console.warn('ÈïøÂ∫¶È™åËØÅÂ§±Ë¥•');
                if (errorMsg) {
                    errorMsg.textContent = 'Please enter a valid length (greater than 0)';
                    errorMsg.style.display = 'block';
                }
                showMessage('Please enter a valid length (greater than 0)', 'error');
                return false;
            }
            if (!width || width <= 0 || isNaN(width)) {
                console.warn('ÂÆΩÂ∫¶È™åËØÅÂ§±Ë¥•');
                if (errorMsg) {
                    errorMsg.textContent = 'Please enter a valid width (greater than 0)';
                    errorMsg.style.display = 'block';
                }
                showMessage('Please enter a valid width (greater than 0)', 'error');
                return false;
            }
            
            // Save dimensions and update display
            roomLength = length;
            roomWidth = width;
            
            const detectedLengthEl = document.getElementById('detectedLength');
            const detectedWidthEl = document.getElementById('detectedWidth');
            
            if (detectedLengthEl) {
                detectedLengthEl.textContent = length.toFixed(2);
            }
            if (detectedWidthEl) {
                detectedWidthEl.textContent = width.toFixed(2);
            }
            if (errorMsg) {
                errorMsg.style.display = 'none';
            }
            
            // Êõ¥Êñ∞Ê≤ôÂèëÂ∞∫ÂØ∏ËåÉÂõ¥ÊòæÁ§∫
            updateSofaSizeRangeDisplay(length, width);
            
            console.log('‚úì Dimensions updated - length:', roomLength, 'width:', roomWidth);
            showMessage(`Dimensions updated: Length=${length.toFixed(2)}m, Width=${width.toFixed(2)}m, sofa size range automatically updated`, 'success');
            
            return false; // Èò≤Ê≠¢Ë°®ÂçïÊèê‰∫§
        };
        
        // ‰øùÁïôÂéüÊù•ÁöÑÂáΩÊï∞ÂÆö‰πâÔºàÂêëÂêéÂÖºÂÆπÔºâ
        function confirmSizeModify() {
            return window.confirmSizeModify();
        }

        function handleSizeDetection(sizeResult) {
            console.log('Processing size detection results:', sizeResult);
            
            const sizeLoading = document.getElementById('sizeLoading');
            const sizeResultDiv = document.getElementById('sizeResult');
            const sizeError = document.getElementById('sizeError');
            
            sizeLoading.style.display = 'none';
            
            if (sizeResult.success) {
                // Recognition successful (may be estimated value)
                roomLength = sizeResult.length;
                roomWidth = sizeResult.width;
                
                document.getElementById('detectedLength').textContent = roomLength.toFixed(2);
                document.getElementById('detectedWidth').textContent = roomWidth.toFixed(2);
                
                // Set default values for manual input fields
                document.getElementById('manualLength').value = roomLength.toFixed(2);
                document.getElementById('manualWidth').value = roomWidth.toFixed(2);
                
                // Show estimated value hint
                const estimatedBadge = document.getElementById('estimatedBadge');
                if (sizeResult.is_estimated) {
                    if (estimatedBadge) {
                        estimatedBadge.style.display = 'block';
                    }
                    showMessage('Room dimensions estimated based on image, please confirm or modify', 'success');
                } else {
                    if (estimatedBadge) {
                        estimatedBadge.style.display = 'none';
                    }
                    showMessage('Living room dimensions identified successfully, you can continue or modify dimensions', 'success');
                }
                
                // Display suitable sofa size range
                if (sizeResult.sofa_length_range && sizeResult.sofa_width_range) {
                    const sofaSizeRange = document.getElementById('sofaSizeRange');
                    const sofaLengthRange = document.getElementById('sofaLengthRange');
                    const sofaWidthRange = document.getElementById('sofaWidthRange');
                    
                    if (sofaSizeRange) {
                        sofaSizeRange.style.display = 'block';
                    }
                    if (sofaLengthRange) {
                        sofaLengthRange.textContent = `${sizeResult.sofa_length_range.min} - ${sizeResult.sofa_length_range.max}`;
                    }
                    if (sofaWidthRange) {
                        sofaWidthRange.textContent = `${sizeResult.sofa_width_range.min} - ${sizeResult.sofa_width_range.max}`;
                    }
                    
                    console.log('Sofa size range:', sizeResult.sofa_length_range, sizeResult.sofa_width_range);
                }
                
                sizeResultDiv.style.display = 'block';
                sizeError.style.display = 'none';
                
                // Automatically proceed to next step (give user some time to view results)
                setTimeout(() => {
                    activateStep(3);
                }, 1500);
            } else {
                // Recognition failed, show error message and manual input
                document.getElementById('sizeErrorMessage').textContent = sizeResult.error || 'Unable to automatically identify dimensions';
                sizeError.style.display = 'block';
                sizeResultDiv.style.display = 'none';
            }
        }

        // Initialize style selection (using event delegation)
        function initializeStyleSelection() {
            // Use event delegation to ensure dynamically loaded elements can respond
            document.addEventListener('click', function(e) {
                // Check if style button was clicked
                if (e.target && e.target.classList.contains('style-btn')) {
                    const btn = e.target;
                    
                    // Check if room dimensions have been entered
                    if (!roomLength || !roomWidth) {
                        showMessage('Please confirm living room dimensions first', 'error');
                        activateStep(2);
                        return;
                    }
                    
                    // Remove selected state from other buttons
                    const allStyleButtons = document.querySelectorAll('.style-btn');
                    allStyleButtons.forEach(b => {
                        b.style.opacity = '1';
                        b.style.transform = 'scale(1)';
                        b.style.background = '#667eea';
                        b.style.border = 'none';
                    });
                    
                    // Select current button
                    btn.style.opacity = '1';
                    btn.style.transform = 'scale(0.95)';
                    btn.style.background = '#764ba2';
                    btn.style.border = '2px solid #764ba2';
                    
                    selectedStyle = btn.getAttribute('data-style');
                    const styleName = btn.textContent.trim();
                    
                    const selectedStyleNameEl = document.getElementById('selectedStyleName');
                    const selectedStyleTextEl = document.getElementById('selectedStyleText');
                    
                    if (selectedStyleNameEl) {
                        selectedStyleNameEl.textContent = styleName;
                    }
                    if (selectedStyleTextEl) {
                        selectedStyleTextEl.style.display = 'block';
                    }
                    
                    showMessage(`Style selected: ${styleName}, loading sofas...`, 'success');
                    
                    // Load sofas of corresponding style
                    loadFurnitureList(selectedStyle);
                    activateStep(4);
                }
            });
        }

        // Load furniture list (filtered by style and size)
        function loadFurnitureList(style = null) {
            let url = '/furniture?';
            if (style) {
                url += `style=${style}&`;
            }
            if (roomLength && roomWidth) {
                url += `room_length=${roomLength}&room_width=${roomWidth}&`;
            }
            
            fetch(url)
            .then(response => response.json())
            .then(data => {
                if (data.furniture) {
                    if (data.furniture.length === 0) {
                        showMessage('No sofas found matching the requirements, please try another style', 'error');
                    } else {
                        displayFurnitureList(data.furniture);
                    }
                } else {
                    showMessage('Failed to load furniture list', 'error');
                }
            })
            .catch(error => {
                showMessage('Failed to load furniture list: ' + error.message, 'error');
            });
        }

        function displayFurnitureList(furnitureList) {
            const grid = document.getElementById('furnitureGrid');
            grid.innerHTML = '';

            furnitureList.forEach(furniture => {
                const item = document.createElement('div');
                item.className = 'furniture-item';
                item.innerHTML = `
                    <img src="${furniture.path}" alt="${furniture.display_name || furniture.name}">
                    <div>${furniture.display_name || furniture.name}</div>
                `;
                
                item.addEventListener('click', () => selectFurniture(furniture, item));
                grid.appendChild(item);
            });
        }

        function selectFurniture(furniture, element) {
            console.log('Selecting furniture:', furniture);
            
            // Clear previous selection
            document.querySelectorAll('.furniture-item').forEach(item => {
                item.classList.remove('selected');
            });
            
            // Select current furniture
            element.classList.add('selected');
            selectedFurniture = furniture;
            
            showMessage(`Furniture selected: ${furniture.display_name || furniture.name}`, 'success');
            
            // Enter step 5 (erase furniture, optional)
            console.log('Entering step 5 - Erase furniture (optional)');
            activateStep(5);
            
            // Delay a bit before setting up erase canvas to ensure DOM is updated
            setTimeout(() => {
                setupEraseCanvas();
            }, 100);
        }

        // Initialize canvas (lazy initialization, only when needed)
        function initializeCanvas() {
            canvas = document.getElementById('drawingCanvas');
            
            // If canvas element doesn't exist, delay initialization
            if (!canvas) {
                console.log('Canvas element not yet loaded, will initialize when needed');
                return;
            }
            
            try {
                ctx = canvas.getContext('2d');
                canvasCursor = document.getElementById('canvasCursor');
                
                // Create mask layer canvas
                maskCanvas = document.createElement('canvas');
                maskCtx = maskCanvas.getContext('2d');
                
                // Set brush style
                ctx.globalCompositeOperation = 'source-over';
                ctx.lineCap = 'round';
                ctx.lineJoin = 'round';
                ctx.globalAlpha = 1.0; // Initial opacity is 1
                
                // Bind events
                canvas.addEventListener('mousedown', startDrawing);
                canvas.addEventListener('mousemove', handleMouseMove);
                canvas.addEventListener('mouseup', stopDrawing);
                canvas.addEventListener('mouseout', hideCanvasCursor);
                canvas.addEventListener('mouseenter', showCanvasCursor);
                
                // Touch event support
                canvas.addEventListener('touchstart', handleTouch);
                canvas.addEventListener('touchmove', handleTouch);
                canvas.addEventListener('touchend', stopDrawing);
                
                console.log('Canvas initialized successfully');
            } catch (error) {
                console.error('Canvas initialization failed:', error);
            }
        }

        function setupCanvas() {
            if (!uploadedImageFile) {
                console.log('Ê≤°Êúâ‰∏ä‰º†ÁöÑÂõæÁâáÔºåÊó†Ê≥ïËÆæÁΩÆcanvas');
                return;
            }
            
            // Á°Æ‰øùcanvasÂ∑≤ÂàùÂßãÂåñÔºàÂåÖÊã¨‰∫ã‰ª∂ÁªëÂÆöÔºâ
            if (!canvas || !ctx) {
                initializeCanvas();
            }
            
            // Â¶ÇÊûúcanvasÂÖÉÁ¥†‰∏çÂ≠òÂú®ÔºåÂ∞ùËØïÈáçÊñ∞Ëé∑Âèñ
            if (!canvas) {
                canvas = document.getElementById('drawingCanvas');
            }
            if (!canvas) {
                console.error('Êó†Ê≥ïÊâæÂà∞canvasÂÖÉÁ¥†');
                showMessage('Unable to find canvas element, please refresh the page and try again', 'error');
                return;
            }
            
            // Â¶ÇÊûúctx‰∏çÂ≠òÂú®ÔºåÈáçÊñ∞Ëé∑Âèñ
            if (!ctx) {
                ctx = canvas.getContext('2d');
            }
            if (!ctx) {
                console.error('Êó†Ê≥ïËé∑Âèñcanvas context');
                showMessage('Unable to get canvas context, please refresh the page and try again', 'error');
                return;
            }
            
            // Á°Æ‰øù‰∫ã‰ª∂Â∑≤ÁªëÂÆöÔºàÂ¶ÇÊûúcanvasÊòØÊñ∞ÂàõÂª∫ÁöÑÊàñÈáçÊñ∞Ëé∑ÂèñÁöÑÔºâ
            if (canvas && !canvas.hasAttribute('data-events-bound')) {
                canvas.addEventListener('mousedown', startDrawing);
                canvas.addEventListener('mousemove', handleMouseMove);
                canvas.addEventListener('mouseup', stopDrawing);
                canvas.addEventListener('mouseout', hideCanvasCursor);
                canvas.addEventListener('mouseenter', showCanvasCursor);
                canvas.addEventListener('touchstart', handleTouch);
                canvas.addEventListener('touchmove', handleTouch);
                canvas.addEventListener('touchend', stopDrawing);
                canvas.setAttribute('data-events-bound', 'true');
                console.log('ÂõæÁîªcanvas‰∫ã‰ª∂Â∑≤ÁªëÂÆö');
            }
            
            // ÈáçÊñ∞ËÆæÁΩÆÁîªÁ¨îÊ†∑ÂºèÔºàÁ°Æ‰øùÂõæÁîªÂäüËÉΩÊ≠£Â∏∏Ôºâ
            ctx.globalCompositeOperation = 'source-over';
            ctx.lineCap = 'round';
            ctx.lineJoin = 'round';
            ctx.globalAlpha = 1.0;
            
            const previewImage = document.getElementById('previewImage');
            const canvasContainer = document.getElementById('canvasContainer');
            
            if (!previewImage || !previewImage.src) {
                console.error('È¢ÑËßàÂõæÁâá‰∏çÂ≠òÂú®');
                return;
            }
            
            // Ëé∑ÂèñÈ¢ÑËßàÂõæÁâáÁöÑsrcÔºåÊ∑ªÂä†ÁºìÂ≠òÁ†¥ÂùèÂèÇÊï∞Á°Æ‰øùÂä†ËΩΩÊúÄÊñ∞ÂõæÁâá
            let imageSrc = previewImage.src;
            // Â¶ÇÊûúsrcÊòØbase64 data URLÔºåÁõ¥Êé•‰ΩøÁî®Ôºå‰∏çË¶ÅÊ∑ªÂä†Êü•ËØ¢ÂèÇÊï∞
            // Â¶ÇÊûúsrcÊòØÊúçÂä°Âô®Ë∑ØÂæÑÔºåÊ∑ªÂä†Êó∂Èó¥Êà≥ÂèÇÊï∞‰ª•ÈÅøÂÖçÁºìÂ≠ò
            if (!imageSrc.startsWith('data:')) {
                // Â¶ÇÊûúsrc‰∏çÂåÖÂê´Êó∂Èó¥Êà≥ÂèÇÊï∞ÔºåÊ∑ªÂä†‰∏Ä‰∏™‰ª•Á°Æ‰øù‰∏ç‰ΩøÁî®ÁºìÂ≠ò
                if (!imageSrc.includes('?t=') && !imageSrc.includes('&t=')) {
                    const separator = imageSrc.includes('?') ? '&' : '?';
                    imageSrc = imageSrc + separator + 't=' + Date.now();
                }
            }
            
            console.log('setupCanvas: ÂáÜÂ§áÂä†ËΩΩÂõæÁâáÔºåË∑ØÂæÑ:', imageSrc);
            console.log('setupCanvas: previewImage.src =', previewImage.src);
            console.log('setupCanvas: uploadedImageFile =', uploadedImageFile);
            
            // ÈôêÂà∂canvasÊúÄÂ§ßÂ∞∫ÂØ∏‰∏∫1024√ó1024ÔºåÈÅøÂÖçÂÜÖÂ≠òÂç†Áî®ËøáÂ§ß
            const MAX_CANVAS_WIDTH = 1024;  // ÊúÄÂ§ßÂÆΩÂ∫¶
            const MAX_CANVAS_HEIGHT = 1024; // ÊúÄÂ§ßÈ´òÂ∫¶
            
            // Á≠âÂæÖÂõæÁâáÂä†ËΩΩÂÆåÊàê
            const img = new Image();
            img.crossOrigin = 'anonymous';
            
            img.onload = function() {
                console.log('setupCanvas: ÂõæÁâáÂä†ËΩΩÊàêÂäüÔºåÂ∞∫ÂØ∏:', img.width, 'x', img.height);
                let canvasWidth = img.width;
                let canvasHeight = img.height;
                const originalWidth = canvasWidth;
                const originalHeight = canvasHeight;
                
                // Â¶ÇÊûúÂõæÁâáË∂ÖËøáÊúÄÂ§ßÂ∞∫ÂØ∏ÔºåÊåâÊØî‰æãÁº©Êîæ
                if (canvasWidth > MAX_CANVAS_WIDTH || canvasHeight > MAX_CANVAS_HEIGHT) {
                    const scale = Math.min(
                        MAX_CANVAS_WIDTH / canvasWidth,
                        MAX_CANVAS_HEIGHT / canvasHeight
                    );
                    canvasWidth = Math.floor(canvasWidth * scale);
                    canvasHeight = Math.floor(canvasHeight * scale);
                    
                    console.log(`ÂõæÁâáÂ∞∫ÂØ∏ËøáÂ§ßÔºåÂ∑≤Áº©Êîæ: ${originalWidth}x${originalHeight} -> ${canvasWidth}x${canvasHeight}`);
                }
                
                // ËÆæÁΩÆÁîªÂ∏ÉÂ∞∫ÂØ∏Ôºà‰ΩøÁî®ÈôêÂà∂ÂêéÁöÑÂ∞∫ÂØ∏Ôºâ
                canvas.width = canvasWidth;
                canvas.height = canvasHeight;
                
                // ËÆæÁΩÆmask canvasÂ∞∫ÂØ∏Ôºà‰∏é‰∏ªcanvasÁõ∏ÂêåÔºâ
                if (!maskCanvas || !maskCtx) {
                    maskCanvas = document.createElement('canvas');
                    maskCtx = maskCanvas.getContext('2d');
                }
                maskCanvas.width = canvasWidth;
                maskCanvas.height = canvasHeight;
                
                // ËÆæÁΩÆÊòæÁ§∫Â∞∫ÂØ∏Ôºà‰ªÖÁî®‰∫éCSSÊòæÁ§∫Ôºå‰∏çÂΩ±ÂìçÂÆûÈôÖcanvasÂÉèÁ¥†Â∞∫ÂØ∏Ôºâ
                const maxWidth = 800;
                const maxHeight = 600;
                let displayWidth = canvasWidth;
                let displayHeight = canvasHeight;
                
                if (displayWidth > maxWidth) {
                    displayHeight = (displayHeight * maxWidth) / displayWidth;
                    displayWidth = maxWidth;
                }
                
                if (displayHeight > maxHeight) {
                    displayWidth = (displayWidth * maxHeight) / displayHeight;
                    displayHeight = maxHeight;
                }
                
                canvas.style.width = displayWidth + 'px';
                canvas.style.height = displayHeight + 'px';
                
                // ÁªòÂà∂ËÉåÊôØÂõæÁâáÔºà‰ΩøÁî®Áº©ÊîæÂêéÁöÑÂ∞∫ÂØ∏Ôºâ
                ctx.globalAlpha = 1.0; // Á°Æ‰øùËÉåÊôØÂõæÁâáÂÆåÂÖ®‰∏çÈÄèÊòé
                ctx.drawImage(img, 0, 0, canvasWidth, canvasHeight);
                saveState();
                
                // Ê∏ÖÁ©∫mask canvas
                maskCtx.clearRect(0, 0, maskCanvas.width, maskCanvas.height);
                
                // ÊòæÁ§∫canvasÂÆπÂô®
                if (canvasContainer) {
                    canvasContainer.style.display = 'block';
                }
                
                // Á°Æ‰øùcanvas cursorÂ∑≤ÂàùÂßãÂåñ
                if (!canvasCursor) {
                    canvasCursor = document.getElementById('canvasCursor');
                }
                
                console.log('ÂõæÁîªcanvasËÆæÁΩÆÂÆåÊàêÔºåÂõæÁîªÂäüËÉΩÂ∑≤ÂáÜÂ§áÂ∞±Áª™');
            };
            
            img.onerror = function() {
                console.error('setupCanvas: Âä†ËΩΩÈ¢ÑËßàÂõæÁâáÂ§±Ë¥•ÔºåË∑ØÂæÑ:', imageSrc);
                console.error('setupCanvas: previewImage.src =', previewImage.src);
                showMessage('Âä†ËΩΩÂõæÁâáÂ§±Ë¥•ÔºåËØ∑Âà∑Êñ∞È°µÈù¢ÈáçËØï', 'error');
            };
            
            img.src = imageSrc;
        }

        function updateCanvasCursor(e) {
            if (!canvasCursor) return;
            
            const rect = canvas.getBoundingClientRect();
            const brushSize = 100; // Âõ∫ÂÆöÁîªÁ¨îÂ§ßÂ∞è100px
            
            // Êõ¥Êñ∞ÂÖâÊ†á‰ΩçÁΩÆÂíåÂ§ßÂ∞è
            const cursorSize = brushSize * (rect.width / canvas.width); // Ê†πÊçÆcanvasÁº©ÊîæË∞ÉÊï¥ÂÖâÊ†áÂ§ßÂ∞è
            canvasCursor.style.width = cursorSize + 'px';
            canvasCursor.style.height = cursorSize + 'px';
            canvasCursor.style.left = (e.clientX - rect.left - cursorSize/2) + 'px';
            canvasCursor.style.top = (e.clientY - rect.top - cursorSize/2) + 'px';
            
            // Êõ¥Êñ∞ÂÖâÊ†áÈÄèÊòéÂ∫¶È¢ÑËßà (Âõ∫ÂÆö40%ÈÄèÊòéÂ∫¶)
            canvasCursor.style.background = `rgba(0, 123, 255, 0.12)`; // 40% * 0.3 = 0.12
        }

        function showCanvasCursor() {
            if (canvasCursor) {
                canvasCursor.style.display = 'block';
            }
        }

        function hideCanvasCursor() {
            if (canvasCursor) {
                canvasCursor.style.display = 'none';
            }
        }

        function handleMouseMove(e) {
            updateCanvasCursor(e);
            if (isDrawing) {
                drawCircle(e);
            }
        }

        function startDrawing(e) {
            isDrawing = true;
            saveState();
            drawCircle(e);
        }

        function drawCircle(e) {
            if (!isDrawing) return;
            
            const rect = canvas.getBoundingClientRect();
            const scaleX = canvas.width / rect.width;
            const scaleY = canvas.height / rect.height;
            
            const x = (e.clientX - rect.left) * scaleX;
            const y = (e.clientY - rect.top) * scaleY;
            const brushSize = 100; // Âõ∫ÂÆöÁîªÁ¨îÂ§ßÂ∞è100px
            const radius = brushSize / 2;
            
            // Âú®mask canvas‰∏äÁªòÂà∂‰∏çÈÄèÊòéÁöÑËìùËâ≤
            maskCtx.globalCompositeOperation = 'source-over';
            maskCtx.globalAlpha = 1.0; // mask‰∏äÂßãÁªà‰∏çÈÄèÊòé
            maskCtx.fillStyle = 'rgb(0, 123, 255)';
            
            maskCtx.beginPath();
            maskCtx.arc(x, y, radius, 0, 2 * Math.PI);
            maskCtx.fill();
            
            // ÈáçÊñ∞ÁªòÂà∂Êï¥‰∏™canvas
            redrawCanvas();
        }

        function redrawCanvas() {
            // Ê∏ÖÈô§‰∏ªcanvas
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            // ÈáçÊñ∞ÁªòÂà∂ËÉåÊôØÂõæÁâá
            if (drawingHistory.length > 0) {
                ctx.putImageData(drawingHistory[0], 0, 0);
            }
            
            // ‰ª•Âõ∫ÂÆö40%ÈÄèÊòéÂ∫¶ÁªòÂà∂mask
            ctx.globalAlpha = 0.4; // Âõ∫ÂÆö40%ÈÄèÊòéÂ∫¶
            ctx.drawImage(maskCanvas, 0, 0);
            ctx.globalAlpha = 1.0; // ÊÅ¢Â§çÈÄèÊòéÂ∫¶
        }

        function stopDrawing() {
            if (isDrawing) {
                isDrawing = false;
                ctx.globalAlpha = 1.0; // ÊÅ¢Â§çÈÄèÊòéÂ∫¶
                checkCanGenerate();
            }
        }

        function handleTouch(e) {
            e.preventDefault();
            const touch = e.touches[0];
            const mouseEvent = new MouseEvent(e.type === 'touchstart' ? 'mousedown' : 
                                            e.type === 'touchmove' ? 'mousemove' : 'mouseup', {
                clientX: touch.clientX,
                clientY: touch.clientY
            });
            
            if (e.type === 'touchstart') {
                startDrawing(mouseEvent);
            } else if (e.type === 'touchmove') {
                handleMouseMove(mouseEvent);
            } else if (e.type === 'touchend') {
                stopDrawing();
            }
        }

        function saveState() {
            drawingHistory.push(ctx.getImageData(0, 0, canvas.width, canvas.height));
            if (drawingHistory.length > 20) {
                drawingHistory.shift();
            }
        }

        function undo() {
            if (drawingHistory.length > 1) {
                drawingHistory.pop();
                const previousState = drawingHistory[drawingHistory.length - 1];
                ctx.putImageData(previousState, 0, 0);
            }
        }

        function clearCanvas() {
            if (drawingHistory.length > 0) {
                const originalState = drawingHistory[0];
                ctx.putImageData(originalState, 0, 0);
                drawingHistory = [originalState];
                
                // Ê∏ÖÁ©∫mask canvas
                maskCtx.clearRect(0, 0, maskCanvas.width, maskCanvas.height);
            }
        }

        // ÂàùÂßãÂåñÊåâÈíÆ‰∫ã‰ª∂ÔºàÂª∂ËøüÂàùÂßãÂåñÔºåÂè™Âú®ÂÖÉÁ¥†Â≠òÂú®Êó∂ÁªëÂÆöÔºâ
        function initializeButtons() {
            // ‰ΩøÁî®‰∫ã‰ª∂ÂßîÊâòÔºåÈÅøÂÖçÂÖÉÁ¥†‰∏çÂ≠òÂú®ÁöÑÈóÆÈ¢ò
            document.addEventListener('click', function(e) {
                // Êí§ÈîÄÊåâÈíÆ
                if (e.target && e.target.id === 'undoBtn') {
                    e.preventDefault();
                    undo();
                }
                // Ê∏ÖÈô§ÊåâÈíÆ
                if (e.target && e.target.id === 'clearBtn') {
                    e.preventDefault();
                    clearCanvas();
                }
                // ÁîüÊàêÊåâÈíÆ
                if (e.target && e.target.id === 'generateBtn') {
                    e.preventDefault();
                    generateDecoration();
                }
            });
            
            // ‰πüÂ∞ùËØïÁõ¥Êé•ÁªëÂÆöÔºàÂ¶ÇÊûúÂÖÉÁ¥†Â∑≤Â≠òÂú®Ôºâ
            setTimeout(() => {
                const undoBtn = document.getElementById('undoBtn');
                const clearBtn = document.getElementById('clearBtn');
                const generateBtn = document.getElementById('generateBtn');
                
                if (undoBtn) {
                    undoBtn.addEventListener('click', undo);
                    console.log('Êí§ÈîÄÊåâÈíÆ‰∫ã‰ª∂Â∑≤ÁªëÂÆö');
                }
                if (clearBtn) {
                    clearBtn.addEventListener('click', clearCanvas);
                    console.log('Ê∏ÖÈô§ÊåâÈíÆ‰∫ã‰ª∂Â∑≤ÁªëÂÆö');
                }
                if (generateBtn) {
                    generateBtn.addEventListener('click', generateDecoration);
                    console.log('ÁîüÊàêÊåâÈíÆ‰∫ã‰ª∂Â∑≤ÁªëÂÆö');
                }
            }, 500);
        }

        // Ê£ÄÊü•ÊòØÂê¶ÂèØ‰ª•ÁîüÊàê
        function checkCanGenerate() {
            const canGenerate = uploadedImageFile && selectedFurniture && drawingHistory.length > 1;
            const generateBtn = document.getElementById('generateBtn');
            if (generateBtn) {
                generateBtn.disabled = !canGenerate;
            }
            
            if (canGenerate) {
                activateStep(7);
            }
        }

        // ÊøÄÊ¥ªÊ≠•È™§
        function activateStep(stepNumber) {
            document.querySelectorAll('.step').forEach(step => {
                step.classList.remove('active');
            });
            const targetStep = document.getElementById(`step${stepNumber}`);
            if (targetStep) {
                targetStep.classList.add('active');
                currentStep = stepNumber;
                
                // ÊªöÂä®Âà∞ÂΩìÂâçÊ≠•È™§
                targetStep.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
            }
        }

        // ÁîüÊàêË£Ö‰øÆÊïàÊûúÂõæ
        function generateDecoration() {
            if (!uploadedImageFile || !selectedFurniture) {
                showMessage('Please complete the previous steps', 'error');
                return;
            }
            
            // ÊòæÁ§∫Âä†ËΩΩÁä∂ÊÄÅ
            const loadingEl = document.getElementById('loading');
            const generateBtn = document.getElementById('generateBtn');
            
            if (loadingEl) {
                loadingEl.classList.add('show');
            }
            if (generateBtn) {
                generateBtn.disabled = true;
            }
            
            // Ëé∑ÂèñmaskÊï∞ÊçÆ - ‰ΩøÁî®Âõ∫ÂÆö40%ÈÄèÊòéÂ∫¶
            const brushOpacity = 0.4; // Âõ∫ÂÆö40%ÈÄèÊòéÂ∫¶
            
            // ÂàõÂª∫‰∏Ä‰∏™‰∏¥Êó∂canvasÊù•ÁîüÊàêÂ∏¶ÈÄèÊòéÂ∫¶ÁöÑmask
            const tempCanvas = document.createElement('canvas');
            tempCanvas.width = maskCanvas.width;
            tempCanvas.height = maskCanvas.height;
            const tempCtx = tempCanvas.getContext('2d');
            
            // Âú®‰∏¥Êó∂canvas‰∏ä‰ª•Âõ∫ÂÆö40%ÈÄèÊòéÂ∫¶ÁªòÂà∂mask
            tempCtx.globalAlpha = brushOpacity;
            tempCtx.drawImage(maskCanvas, 0, 0);
            
            // Ëé∑ÂèñÂ∫îÁî®‰∫ÜÈÄèÊòéÂ∫¶ÁöÑmaskÊï∞ÊçÆ
            const maskData = tempCanvas.toDataURL('image/png');
            
            console.log(`‰øùÂ≠òmaskÊï∞ÊçÆÔºåÂõ∫ÂÆöÈÄèÊòéÂ∫¶ËÆæÁΩÆ: 40%`);
            console.log(`MaskÊï∞ÊçÆÈïøÂ∫¶: ${maskData.length}`);
            
            // ÂÖà‰øùÂ≠òmaskÂõæÁâá
            fetch('/save_mask', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    original_image: uploadedImageFile,
                    mask_data: maskData
                })
            })
            .then(response => {
                // Ê£ÄÊü•ÂìçÂ∫îÁä∂ÊÄÅ
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                // Ê£ÄÊü•ÂìçÂ∫îÂÜÖÂÆπÁ±ªÂûã
                const contentType = response.headers.get('content-type');
                if (!contentType || !contentType.includes('application/json')) {
                    return response.text().then(text => {
                        throw new Error(`Expected JSON but got: ${contentType}. Response: ${text.substring(0, 200)}`);
                    });
                }
                return response.json();
            })
            .then(data => {
                if (data.success) {
                    // Ë∞ÉÁî®ÁîüÊàêAPI
                    return fetch('/generate_v1', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            original_image: uploadedImageFile,
                            selected_furniture: selectedFurniture.name,
                            mask_filename: data.mask_filename
                        })
                    });
                } else {
                    throw new Error(data.error || 'Failed to save mask');
                }
            })
            .then(response => {
                // Ê£ÄÊü•ÂìçÂ∫îÁä∂ÊÄÅ
                if (!response.ok) {
                    return response.text().then(text => {
                        let errorMsg = `HTTP error! status: ${response.status}`;
                        try {
                            // Â∞ùËØïËß£Êûê‰∏∫JSON
                            const errorData = JSON.parse(text);
                            errorMsg = errorData.error || errorMsg;
                        } catch (e) {
                            // Â¶ÇÊûú‰∏çÊòØJSONÔºå‰ΩøÁî®ÂéüÂßãÊñáÊú¨
                            errorMsg = text || errorMsg;
                        }
                        throw new Error(errorMsg);
                    });
                }
                // Ê£ÄÊü•ÂìçÂ∫îÂÜÖÂÆπÁ±ªÂûã
                const contentType = response.headers.get('content-type');
                if (!contentType || !contentType.includes('application/json')) {
                    return response.text().then(text => {
                        throw new Error(`Expected JSON but got: ${contentType}. Response: ${text.substring(0, 200)}`);
                    });
                }
                return response.json();
            })
            .then(data => {
                const loadingEl = document.getElementById('loading');
                const generateBtn = document.getElementById('generateBtn');
                
                if (loadingEl) {
                    loadingEl.classList.remove('show');
                }
                if (generateBtn) {
                    generateBtn.disabled = false;
                }
                
                if (data.success) {
                    displayResults(data.generated_images);
                    showMessage(data.message, 'success');
                } else {
                    showMessage(data.error || 'Generation failed', 'error');
                }
            })
            .catch(error => {
                const loadingEl = document.getElementById('loading');
                const generateBtn = document.getElementById('generateBtn');
                
                if (loadingEl) {
                    loadingEl.classList.remove('show');
                }
                if (generateBtn) {
                    generateBtn.disabled = false;
                }
                
                console.error('Generation error:', error);
                const errorMessage = error.message || 'Generation failed';
                showMessage('Generation failed: ' + errorMessage, 'error');
            });
        }

        // ÊòæÁ§∫ÁªìÊûú
        function displayResults(images) {
            const container = document.getElementById('resultContainer');
            container.innerHTML = '<h3>üéâ Generation Successful!</h3>';
            
            images.forEach((image, index) => {
                const imgElement = document.createElement('img');
                imgElement.src = image.path;
                imgElement.className = 'result-image';
                imgElement.style.margin = '20px 10px';
                container.appendChild(imgElement);
                
                // Ê∑ªÂä†‰∏ãËΩΩÈìæÊé•
                const downloadLink = document.createElement('a');
                downloadLink.href = image.path;
                downloadLink.download = image.filename;
                downloadLink.className = 'btn';
                downloadLink.style.margin = '10px';
                downloadLink.textContent = `Download Image ${index + 1}`;
                container.appendChild(downloadLink);
            });
        }

        // ÊòæÁ§∫Ê∂àÊÅØ
        function showMessage(text, type = 'success') {
            const message = document.getElementById('message');
            message.textContent = text;
            message.className = `message ${type} show`;
            
            setTimeout(() => {
                message.classList.remove('show');
            }, 5000);
        }
        
        // ÂàùÂßãÂåñÊ†áÁ≠æÈ°µÔºàÂ∑≤ÁßªÈô§ÔºåÊì¶Èô§Áé∞Âú®ÊòØÁã¨Á´ãÊ≠•È™§Ôºâ
        function initializeTabs() {
            // Ê†áÁ≠æÈ°µÂäüËÉΩÂ∑≤ÁßªÈô§ÔºåÊì¶Èô§Áé∞Âú®ÊòØÊ≠•È™§5ÔºåÂõæÁîªÊòØÊ≠•È™§6
        }
        
        // ÂàùÂßãÂåñÊì¶Èô§Canvas
        function initializeEraseCanvas() {
            eraseCanvas = document.getElementById('eraseCanvas');
            if (!eraseCanvas) return;
            
            try {
                eraseCtx = eraseCanvas.getContext('2d');
                eraseCanvasCursor = document.getElementById('eraseCanvasCursor');
                
                // ÂàõÂª∫Êì¶Èô§maskÂõæÂ±Çcanvas
                eraseMaskCanvas = document.createElement('canvas');
                eraseMaskCtx = eraseMaskCanvas.getContext('2d');
                
                // ËÆæÁΩÆÁîªÁ¨îÊ†∑Âºè
                eraseCtx.globalCompositeOperation = 'source-over';
                eraseCtx.lineCap = 'round';
                eraseCtx.lineJoin = 'round';
                eraseCtx.globalAlpha = 1.0;
                
                // ÁªëÂÆö‰∫ã‰ª∂
                eraseCanvas.addEventListener('mousedown', startErasing);
                eraseCanvas.addEventListener('mousemove', handleEraseMouseMove);
                eraseCanvas.addEventListener('mouseup', stopErasing);
                eraseCanvas.addEventListener('mouseout', hideEraseCanvasCursor);
                eraseCanvas.addEventListener('mouseenter', showEraseCanvasCursor);
                
                // Ëß¶Êë∏‰∫ã‰ª∂ÊîØÊåÅ
                eraseCanvas.addEventListener('touchstart', handleEraseTouch);
                eraseCanvas.addEventListener('touchmove', handleEraseTouch);
                eraseCanvas.addEventListener('touchend', stopErasing);
                
                console.log('Êì¶Èô§CanvasÂàùÂßãÂåñÊàêÂäü');
            } catch (error) {
                console.error('Êì¶Èô§CanvasÂàùÂßãÂåñÂ§±Ë¥•:', error);
            }
        }
        
        // ËÆæÁΩÆÊì¶Èô§Canvas
        function setupEraseCanvas() {
            if (!uploadedImageFile) {
                console.log('Ê≤°Êúâ‰∏ä‰º†ÁöÑÂõæÁâáÔºåÊó†Ê≥ïËÆæÁΩÆÊì¶Èô§canvas');
                return;
            }
            
            if (!eraseCanvas || !eraseCtx) {
                initializeEraseCanvas();
            }
            
            if (!eraseCanvas || !eraseCtx) {
                console.error('Êó†Ê≥ïÂàùÂßãÂåñÊì¶Èô§canvas');
                return;
            }
            
            const previewImage = document.getElementById('previewImage');
            const eraseCanvasContainer = document.getElementById('eraseCanvasContainer');
            
            if (!previewImage || !previewImage.src) {
                console.error('È¢ÑËßàÂõæÁâá‰∏çÂ≠òÂú®');
                return;
            }
            
            // ‰ΩøÁî®‰∏é‰∏ªcanvasÁõ∏ÂêåÁöÑÂ∞∫ÂØ∏ÈôêÂà∂
            const MAX_CANVAS_WIDTH = 1024;
            const MAX_CANVAS_HEIGHT = 1024;
            
            // Á≠âÂæÖÂõæÁâáÂä†ËΩΩÂÆåÊàê
            const img = new Image();
            img.crossOrigin = 'anonymous';
            
            img.onload = function() {
                console.log('Êì¶Èô§canvasËÉåÊôØÂõæÁâáÂä†ËΩΩÊàêÂäüÔºåÂ∞∫ÂØ∏:', img.width, 'x', img.height);
                
                let canvasWidth = img.width;
                let canvasHeight = img.height;
                const originalWidth = canvasWidth;
                const originalHeight = canvasHeight;
                
                // Â¶ÇÊûúÂõæÁâáË∂ÖËøáÊúÄÂ§ßÂ∞∫ÂØ∏ÔºåÊåâÊØî‰æãÁº©Êîæ
                if (canvasWidth > MAX_CANVAS_WIDTH || canvasHeight > MAX_CANVAS_HEIGHT) {
                    const scale = Math.min(
                        MAX_CANVAS_WIDTH / canvasWidth,
                        MAX_CANVAS_HEIGHT / canvasHeight
                    );
                    canvasWidth = Math.floor(canvasWidth * scale);
                    canvasHeight = Math.floor(canvasHeight * scale);
                    console.log(`Êì¶Èô§canvasÂ∞∫ÂØ∏Áº©Êîæ: ${originalWidth}x${originalHeight} -> ${canvasWidth}x${canvasHeight}`);
                }
                
                // ËÆæÁΩÆÁîªÂ∏ÉÂ∞∫ÂØ∏
                eraseCanvas.width = canvasWidth;
                eraseCanvas.height = canvasHeight;
                
                // ËÆæÁΩÆmask canvasÂ∞∫ÂØ∏
                if (!eraseMaskCanvas || !eraseMaskCtx) {
                    eraseMaskCanvas = document.createElement('canvas');
                    eraseMaskCtx = eraseMaskCanvas.getContext('2d');
                }
                eraseMaskCanvas.width = canvasWidth;
                eraseMaskCanvas.height = canvasHeight;
                
                // ËÆæÁΩÆÊòæÁ§∫Â∞∫ÂØ∏
                const maxWidth = 800;
                const maxHeight = 600;
                let displayWidth = canvasWidth;
                let displayHeight = canvasHeight;
                
                if (displayWidth > maxWidth) {
                    displayHeight = (displayHeight * maxWidth) / displayWidth;
                    displayWidth = maxWidth;
                }
                
                if (displayHeight > maxHeight) {
                    displayWidth = (displayWidth * maxHeight) / displayHeight;
                    displayHeight = maxHeight;
                }
                
                eraseCanvas.style.width = displayWidth + 'px';
                eraseCanvas.style.height = displayHeight + 'px';
                
                // ÁªòÂà∂ËÉåÊôØÂõæÁâá
                eraseCtx.globalAlpha = 1.0;
                eraseCtx.drawImage(img, 0, 0, canvasWidth, canvasHeight);
                saveEraseState();
                
                // Ê∏ÖÁ©∫mask canvas
                eraseMaskCtx.clearRect(0, 0, eraseMaskCanvas.width, eraseMaskCanvas.height);
                
                // ÊòæÁ§∫canvasÂÆπÂô®
                if (eraseCanvasContainer) {
                    eraseCanvasContainer.style.display = 'block';
                    console.log('Êì¶Èô§canvasÂ∑≤ÊòæÁ§∫');
                }
            };
            
            img.onerror = function() {
                console.error('Âä†ËΩΩÊì¶Èô§canvasËÉåÊôØÂõæÁâáÂ§±Ë¥•:', previewImage.src);
                showMessage('Âä†ËΩΩÂõæÁâáÂ§±Ë¥•ÔºåËØ∑Âà∑Êñ∞È°µÈù¢ÈáçËØï', 'error');
            };
            
            // ‰ΩøÁî®È¢ÑËßàÂõæÁâáÁöÑsrc
            img.src = previewImage.src;
        }
        
        // Êì¶Èô§Áõ∏ÂÖ≥ÂáΩÊï∞
        function startErasing(e) {
            isErasing = true;
            saveEraseState();
            drawEraseCircle(e);
        }
        
        function drawEraseCircle(e) {
            if (!isErasing) return;
            
            const rect = eraseCanvas.getBoundingClientRect();
            const scaleX = eraseCanvas.width / rect.width;
            const scaleY = eraseCanvas.height / rect.height;
            
            const x = (e.clientX - rect.left) * scaleX;
            const y = (e.clientY - rect.top) * scaleY;
            const brushSize = 100;
            const radius = brushSize / 2;
            
            // Âú®mask canvas‰∏äÁªòÂà∂ÁôΩËâ≤ÔºàË°®Á§∫Ë¶ÅÊì¶Èô§ÁöÑÂå∫ÂüüÔºâ
            eraseMaskCtx.globalCompositeOperation = 'source-over';
            eraseMaskCtx.globalAlpha = 1.0;
            eraseMaskCtx.fillStyle = 'rgb(255, 255, 255)'; // ÁôΩËâ≤Ë°®Á§∫Ë¶ÅÊì¶Èô§
            
            eraseMaskCtx.beginPath();
            eraseMaskCtx.arc(x, y, radius, 0, 2 * Math.PI);
            eraseMaskCtx.fill();
            
            // ÈáçÊñ∞ÁªòÂà∂Êï¥‰∏™canvas
            redrawEraseCanvas();
        }
        
        function redrawEraseCanvas() {
            // Ê∏ÖÈô§‰∏ªcanvas
            eraseCtx.clearRect(0, 0, eraseCanvas.width, eraseCanvas.height);
            
            // ÈáçÊñ∞ÁªòÂà∂ËÉåÊôØÂõæÁâá
            if (eraseHistory.length > 0) {
                eraseCtx.putImageData(eraseHistory[0], 0, 0);
            }
            
            // ‰ª•Á∫¢Ëâ≤ÂçäÈÄèÊòéÊòæÁ§∫Ë¶ÅÊì¶Èô§ÁöÑÂå∫ÂüüÔºàÈ¢ÑËßàÊïàÊûúÔºâ
            eraseCtx.globalAlpha = 0.5;
            eraseCtx.drawImage(eraseMaskCanvas, 0, 0);
            eraseCtx.globalAlpha = 1.0;
        }
        
        function stopErasing() {
            if (isErasing) {
                isErasing = false;
                eraseCtx.globalAlpha = 1.0;
            }
        }
        
        function handleEraseMouseMove(e) {
            updateEraseCanvasCursor(e);
            if (isErasing) {
                drawEraseCircle(e);
            }
        }
        
        function updateEraseCanvasCursor(e) {
            if (!eraseCanvasCursor) return;
            
            const rect = eraseCanvas.getBoundingClientRect();
            const brushSize = 100;
            
            const cursorSize = brushSize * (rect.width / eraseCanvas.width);
            eraseCanvasCursor.style.width = cursorSize + 'px';
            eraseCanvasCursor.style.height = cursorSize + 'px';
            eraseCanvasCursor.style.left = (e.clientX - rect.left - cursorSize/2) + 'px';
            eraseCanvasCursor.style.top = (e.clientY - rect.top - cursorSize/2) + 'px';
            eraseCanvasCursor.style.background = `rgba(255, 0, 0, 0.3)`;
        }
        
        function showEraseCanvasCursor() {
            if (eraseCanvasCursor) {
                eraseCanvasCursor.style.display = 'block';
            }
        }
        
        function hideEraseCanvasCursor() {
            if (eraseCanvasCursor) {
                eraseCanvasCursor.style.display = 'none';
            }
        }
        
        function handleEraseTouch(e) {
            e.preventDefault();
            const touch = e.touches[0];
            const mouseEvent = new MouseEvent(e.type === 'touchstart' ? 'mousedown' : 
                                            e.type === 'touchmove' ? 'mousemove' : 'mouseup', {
                clientX: touch.clientX,
                clientY: touch.clientY
            });
            
            if (e.type === 'touchstart') {
                startErasing(mouseEvent);
            } else if (e.type === 'touchmove') {
                handleEraseMouseMove(mouseEvent);
            } else if (e.type === 'touchend') {
                stopErasing();
            }
        }
        
        function saveEraseState() {
            eraseHistory.push(eraseCtx.getImageData(0, 0, eraseCanvas.width, eraseCanvas.height));
            if (eraseHistory.length > 20) {
                eraseHistory.shift();
            }
        }
        
        function eraseUndo() {
            if (eraseHistory.length > 1) {
                eraseHistory.pop();
                const previousState = eraseHistory[eraseHistory.length - 1];
                eraseCtx.putImageData(previousState, 0, 0);
                
                // Ê∏ÖÁ©∫mask canvas
                eraseMaskCtx.clearRect(0, 0, eraseMaskCanvas.width, eraseMaskCanvas.height);
            }
        }
        
        function eraseClear() {
            if (eraseHistory.length > 0) {
                const originalState = eraseHistory[0];
                eraseCtx.putImageData(originalState, 0, 0);
                eraseHistory = [originalState];
                
                // Ê∏ÖÁ©∫mask canvas
                eraseMaskCtx.clearRect(0, 0, eraseMaskCanvas.width, eraseMaskCanvas.height);
            }
        }
        
        // ÂºÄÂßãÊì¶Èô§
        function startErase() {
            if (!uploadedImageFile) {
                showMessage('ËØ∑ÂÖà‰∏ä‰º†ÂÆ¢ÂéÖÂõæÁâá', 'error');
                return;
            }
            
            // Ê£ÄÊü•ÊòØÂê¶ÊúâÁªòÂà∂ËíôÁâà
            const hasMask = eraseMaskCanvas && !isCanvasEmpty(eraseMaskCanvas);
            if (!hasMask) {
                showMessage('ËØ∑ÂÖàÂú®ÂõæÁâá‰∏äÊ∂ÇÊäπË¶ÅÊì¶Èô§ÁöÑÂÆ∂ÂÖ∑Âå∫Âüü', 'error');
                return;
            }
            
            // ÊòæÁ§∫Âä†ËΩΩÁä∂ÊÄÅ
            const eraseLoading = document.getElementById('eraseLoading');
            const startEraseBtn = document.getElementById('startEraseBtn');
            
            if (eraseLoading) {
                eraseLoading.style.display = 'block';
            }
            if (startEraseBtn) {
                startEraseBtn.disabled = true;
            }
            
            // Ëé∑ÂèñÂéüÂßãÂõæÁâáÂíåËíôÁâà
            const previewImage = document.getElementById('previewImage');
            const originalImageUrl = previewImage.src;
            
            // ÂàõÂª∫‰∏Ä‰∏™Á∫ØÈªëÁôΩÁöÑmask canvasÔºàÁôΩËâ≤=Ë¶ÅÊì¶Èô§ÔºåÈªëËâ≤=‰øùÁïôÔºâ
            const binaryMaskCanvas = document.createElement('canvas');
            binaryMaskCanvas.width = eraseMaskCanvas.width;
            binaryMaskCanvas.height = eraseMaskCanvas.height;
            const binaryMaskCtx = binaryMaskCanvas.getContext('2d');
            
            // ÂÖàÁªòÂà∂ÈªëËâ≤ËÉåÊôØÔºà‰øùÁïôÂå∫ÂüüÔºâ
            binaryMaskCtx.fillStyle = 'rgb(0, 0, 0)';
            binaryMaskCtx.fillRect(0, 0, binaryMaskCanvas.width, binaryMaskCanvas.height);
            
            // Ëé∑ÂèñeraseMaskCanvasÁöÑÂÉèÁ¥†Êï∞ÊçÆÔºåÊâæÂá∫ÁôΩËâ≤Âå∫Âüü
            const maskImageData = eraseMaskCtx.getImageData(0, 0, eraseMaskCanvas.width, eraseMaskCanvas.height);
            const maskData = maskImageData.data;
            
            // ÂàõÂª∫Êñ∞ÁöÑImageDataÁî®‰∫éÁ∫ØÈªëÁôΩËíôÁâà
            const binaryImageData = binaryMaskCtx.createImageData(binaryMaskCanvas.width, binaryMaskCanvas.height);
            const binaryData = binaryImageData.data;
            
            // ÈÅçÂéÜÊØè‰∏™ÂÉèÁ¥†ÔºåÂ∞ÜÈùûÈªëËâ≤ÔºàÊúâÁªòÂà∂ÔºâÁöÑÂå∫ÂüüËÆæ‰∏∫ÁôΩËâ≤ÔºåÂÖ∂‰Ωô‰øùÊåÅÈªëËâ≤
            for (let i = 0; i < maskData.length; i += 4) {
                const r = maskData[i];
                const g = maskData[i + 1];
                const b = maskData[i + 2];
                const a = maskData[i + 3];
                
                // Â¶ÇÊûúÂÉèÁ¥†‰∏çÊòØÂÆåÂÖ®ÈÄèÊòé‰∏î‰∏çÊòØÈªëËâ≤ÔºåÂàôËÆæ‰∏∫ÁôΩËâ≤ÔºàË¶ÅÊì¶Èô§ÁöÑÂå∫ÂüüÔºâ
                if (a > 0 && (r > 0 || g > 0 || b > 0)) {
                    binaryData[i] = 255;     // R
                    binaryData[i + 1] = 255; // G
                    binaryData[i + 2] = 255; // B
                    binaryData[i + 3] = 255; // A (ÂÆåÂÖ®‰∏çÈÄèÊòé)
                } else {
                    // ‰øùÊåÅÈªëËâ≤Ôºà‰øùÁïôÂå∫ÂüüÔºâ
                    binaryData[i] = 0;       // R
                    binaryData[i + 1] = 0;   // G
                    binaryData[i + 2] = 0;   // B
                    binaryData[i + 3] = 255; // A (ÂÆåÂÖ®‰∏çÈÄèÊòé)
                }
            }
            
            // Â∞ÜÂ§ÑÁêÜÂêéÁöÑImageDataÁªòÂà∂Âà∞canvas‰∏ä
            binaryMaskCtx.putImageData(binaryImageData, 0, 0);
            
            console.log('ËíôÁâàÂ∑≤ËΩ¨Êç¢‰∏∫Á∫ØÈªëÁôΩÊ†ºÂºèÔºàÁôΩËâ≤=Êì¶Èô§ÔºåÈªëËâ≤=‰øùÁïôÔºâ');
            
            // Â∞Ümask canvasËΩ¨Êç¢‰∏∫blob
            binaryMaskCanvas.toBlob(function(maskBlob) {
                // Â∞ÜÂéüÂßãÂõæÁâáËΩ¨Êç¢‰∏∫blob
                fetch(originalImageUrl)
                    .then(response => response.blob())
                    .then(originalBlob => {
                        // ÂàõÂª∫FormData
                        const formData = new FormData();
                        formData.append('original_image', originalBlob, 'original.jpg');
                        formData.append('mask_image', maskBlob, 'mask.png');
                        
                        // Ë∞ÉÁî®API
                        fetch('/api/inpaint', {
                            method: 'POST',
                            body: formData
                        })
                        .then(response => response.json())
                        .then(data => {
                            if (eraseLoading) {
                                eraseLoading.style.display = 'none';
                            }
                            if (startEraseBtn) {
                                startEraseBtn.disabled = false;
                            }
                            
                            if (data.success && data.generated_images && data.generated_images.length > 0) {
                                // ‰ΩøÁî®Á¨¨‰∏ÄÂº†ÁîüÊàêÁöÑÂõæÁâá
                                const resultImage = data.generated_images[0];
                                
                                console.log('Êì¶Èô§ÊàêÂäüÔºåÁîüÊàêÁöÑÂõæÁâá:', resultImage);
                                
                                // Â∞ÜÊì¶Èô§ÂêéÁöÑÂõæÁâáÂä†ËΩΩÂà∞ÂõæÁîªcanvas‰∏≠ÔºàËøô‰∏™ÂáΩÊï∞‰ºöÂ§ÑÁêÜÊâÄÊúâËÆæÁΩÆÔºâ
                                loadErasedImageToDrawCanvas(resultImage.path, resultImage.filename);
                                
                                showMessage('Êì¶Èô§ÊàêÂäüÔºÅÂõæÁâáÂ∑≤Êõ¥Êñ∞ÔºåËá™Âä®ËøõÂÖ•ÂõæÁîªÊ≠•È™§', 'success');
                                
                                // Ëá™Âä®ËøõÂÖ•Ê≠•È™§6ÔºàÂõæÁîªÔºâ- ‰∏çÈúÄË¶ÅÂÜçÊ¨°Ë∞ÉÁî®setupCanvasÔºåÂõ†‰∏∫loadErasedImageToDrawCanvasÂ∑≤ÁªèÂ§ÑÁêÜ‰∫Ü
                                setTimeout(() => {
                                    activateStep(6);
                                }, 1500);
                            } else {
                                showMessage(data.error || 'Êì¶Èô§Â§±Ë¥•', 'error');
                            }
                        })
                        .catch(error => {
                            if (eraseLoading) {
                                eraseLoading.style.display = 'none';
                            }
                            if (startEraseBtn) {
                                startEraseBtn.disabled = false;
                            }
                            console.error('Êì¶Èô§ÈîôËØØ:', error);
                            showMessage('Êì¶Èô§Â§±Ë¥•: ' + error.message, 'error');
                        });
                    })
                    .catch(error => {
                        if (eraseLoading) {
                            eraseLoading.style.display = 'none';
                        }
                        if (startEraseBtn) {
                            startEraseBtn.disabled = false;
                        }
                        console.error('Âä†ËΩΩÂéüÂßãÂõæÁâáÂ§±Ë¥•:', error);
                        showMessage('Âä†ËΩΩÂéüÂßãÂõæÁâáÂ§±Ë¥•', 'error');
                    });
            }, 'image/png');
        }
        
        // Ê£ÄÊü•canvasÊòØÂê¶‰∏∫Á©∫
        function isCanvasEmpty(canvas) {
            const ctx = canvas.getContext('2d');
            const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
            const data = imageData.data;
            
            // Ê£ÄÊü•ÊòØÂê¶ÊúâÈùûÈÄèÊòéÂÉèÁ¥†
            for (let i = 3; i < data.length; i += 4) {
                if (data[i] > 0) {
                    return false;
                }
            }
            return true;
        }
        
        // Â∞ÜÊì¶Èô§ÂêéÁöÑÂõæÁâáÂä†ËΩΩÂà∞ÂõæÁîªcanvas
        function loadErasedImageToDrawCanvas(imagePath, filename) {
            console.log('ÂºÄÂßãÂä†ËΩΩÊì¶Èô§ÂêéÁöÑÂõæÁâá:', imagePath, 'Êñá‰ª∂Âêç:', filename);
            
            // ÊûÑÂª∫ÂÆåÊï¥ÁöÑÂõæÁâáURL
            let fullImagePath = imagePath;
            if (!imagePath.startsWith('http') && !imagePath.startsWith('/')) {
                fullImagePath = '/' + imagePath;
            }
            if (!fullImagePath.startsWith('http')) {
                fullImagePath = window.location.origin + fullImagePath;
            }
            
            console.log('ÂÆåÊï¥ÂõæÁâáË∑ØÂæÑ:', fullImagePath);
            
            const img = new Image();
            img.crossOrigin = 'anonymous'; // ÂÖÅËÆ∏Ë∑®ÂüüÂä†ËΩΩ
            
            img.onload = function() {
                console.log('Êì¶Èô§ÂêéÁöÑÂõæÁâáÂä†ËΩΩÊàêÂäüÔºåÂ∞∫ÂØ∏:', img.width, 'x', img.height);
                
                // Êõ¥Êñ∞È¢ÑËßàÂõæÁâáÔºàÂÖàÊõ¥Êñ∞È¢ÑËßàÔºåËøôÊ†∑canvasÂèØ‰ª•Ëé∑ÂèñÊ≠£Á°ÆÁöÑÂ∞∫ÂØ∏Ôºâ
                const previewImage = document.getElementById('previewImage');
                
                // Ê∏ÖÈô§ÂèØËÉΩÁöÑÁºìÂ≠òÔºåÁ°Æ‰øùÂä†ËΩΩÊñ∞ÂõæÁâá
                const cacheBuster = '?t=' + Date.now();
                const imageUrlWithCacheBuster = fullImagePath + (fullImagePath.includes('?') ? '&' : '?') + cacheBuster;
                
                // ÂÖàÊõ¥Êñ∞È¢ÑËßàÂõæÁâásrcÔºàÊ∑ªÂä†ÁºìÂ≠òÁ†¥ÂùèÂèÇÊï∞ÔºåÁ°Æ‰øùÂä†ËΩΩÊñ∞ÂõæÁâáÔºâ
                // ËøôÊ†∑ÂêéÁª≠ÁöÑsetupCanvasÂáΩÊï∞Â∞±ËÉΩ‰ΩøÁî®Ê≠£Á°ÆÁöÑÂõæÁâáË∑ØÂæÑ
                previewImage.onload = null;
                previewImage.onerror = null;
                previewImage.src = imageUrlWithCacheBuster;
                console.log('È¢ÑËßàÂõæÁâásrcÂ∑≤Êõ¥Êñ∞‰∏∫:', imageUrlWithCacheBuster);
                
                // ‰ΩøÁî®Â∑≤Âä†ËΩΩÁöÑimgÂØπË±°ÔºàÊì¶Èô§ÂêéÁöÑÂõæÁâáÔºâÊù•ËÆæÁΩÆcanvas
                // ËøôÊ†∑Á°Æ‰øùcanvas‰ΩøÁî®ÁöÑÊòØÊì¶Èô§ÂêéÁöÑÂõæÁâáÔºåËÄå‰∏çÊòØ‰æùËµñpreviewImage.srcÔºàÂèØËÉΩÊúâÂª∂ËøüÔºâ
                const setupDrawCanvas = function() {
                    // Á°Æ‰øùcanvasÂ∑≤ÂàùÂßãÂåñÔºàÂåÖÊã¨‰∫ã‰ª∂ÁªëÂÆöÔºâ
                    if (!canvas || !ctx) {
                        initializeCanvas();
                    }
                    
                    // Â¶ÇÊûúcanvasÂÖÉÁ¥†‰∏çÂ≠òÂú®ÔºåÂ∞ùËØïÈáçÊñ∞Ëé∑Âèñ
                    if (!canvas) {
                        canvas = document.getElementById('drawingCanvas');
                    }
                    if (!canvas) {
                        console.error('Êó†Ê≥ïÊâæÂà∞canvasÂÖÉÁ¥†');
                        showMessage('Êó†Ê≥ïÊâæÂà∞canvasÂÖÉÁ¥†ÔºåËØ∑Âà∑Êñ∞È°µÈù¢ÈáçËØï', 'error');
                        return;
                    }
                    
                    // Â¶ÇÊûúctx‰∏çÂ≠òÂú®ÔºåÈáçÊñ∞Ëé∑Âèñ
                    if (!ctx) {
                        ctx = canvas.getContext('2d');
                    }
                    if (!ctx) {
                        console.error('Êó†Ê≥ïËé∑Âèñcanvas context');
                        showMessage('Êó†Ê≥ïËé∑Âèñcanvas contextÔºåËØ∑Âà∑Êñ∞È°µÈù¢ÈáçËØï', 'error');
                        return;
                    }
                    
                    // Á°Æ‰øù‰∫ã‰ª∂Â∑≤ÁªëÂÆöÔºàÂ¶ÇÊûúcanvasÊòØÊñ∞ÂàõÂª∫ÁöÑÊàñÈáçÊñ∞Ëé∑ÂèñÁöÑÔºâ
                    if (canvas && !canvas.hasAttribute('data-events-bound')) {
                        canvas.addEventListener('mousedown', startDrawing);
                        canvas.addEventListener('mousemove', handleMouseMove);
                        canvas.addEventListener('mouseup', stopDrawing);
                        canvas.addEventListener('mouseout', hideCanvasCursor);
                        canvas.addEventListener('mouseenter', showCanvasCursor);
                        canvas.addEventListener('touchstart', handleTouch);
                        canvas.addEventListener('touchmove', handleTouch);
                        canvas.addEventListener('touchend', stopDrawing);
                        canvas.setAttribute('data-events-bound', 'true');
                        console.log('ÂõæÁîªcanvas‰∫ã‰ª∂Â∑≤ÈáçÊñ∞ÁªëÂÆö');
                    }
                    
                    // ‰ΩøÁî®‰∏éÊì¶Èô§canvasÁõ∏ÂêåÁöÑÂ∞∫ÂØ∏ÈôêÂà∂
                    const MAX_CANVAS_WIDTH = 1024;
                    const MAX_CANVAS_HEIGHT = 1024;
                    
                    let canvasWidth = img.width;
                    let canvasHeight = img.height;
                    const originalWidth = canvasWidth;
                    const originalHeight = canvasHeight;
                    
                    // Â¶ÇÊûúÂõæÁâáË∂ÖËøáÊúÄÂ§ßÂ∞∫ÂØ∏ÔºåÊåâÊØî‰æãÁº©Êîæ
                    if (canvasWidth > MAX_CANVAS_WIDTH || canvasHeight > MAX_CANVAS_HEIGHT) {
                        const scale = Math.min(
                            MAX_CANVAS_WIDTH / canvasWidth,
                            MAX_CANVAS_HEIGHT / canvasHeight
                        );
                        canvasWidth = Math.floor(canvasWidth * scale);
                        canvasHeight = Math.floor(canvasHeight * scale);
                        console.log(`ÂõæÁîªcanvasÂ∞∫ÂØ∏Áº©Êîæ: ${originalWidth}x${originalHeight} -> ${canvasWidth}x${canvasHeight}`);
                    }
                    
                    // ËÆæÁΩÆÁîªÂ∏ÉÂ∞∫ÂØ∏
                    canvas.width = canvasWidth;
                    canvas.height = canvasHeight;
                    
                    // ÈáçÊñ∞ËÆæÁΩÆÁîªÁ¨îÊ†∑ÂºèÔºàÁ°Æ‰øùÂõæÁîªÂäüËÉΩÊ≠£Â∏∏Ôºâ
                    ctx.globalCompositeOperation = 'source-over';
                    ctx.lineCap = 'round';
                    ctx.lineJoin = 'round';
                    ctx.globalAlpha = 1.0;
                    
                    // ËÆæÁΩÆmask canvasÂ∞∫ÂØ∏
                    if (!maskCanvas || !maskCtx) {
                        maskCanvas = document.createElement('canvas');
                        maskCtx = maskCanvas.getContext('2d');
                    }
                    maskCanvas.width = canvasWidth;
                    maskCanvas.height = canvasHeight;
                    
                    // ËÆæÁΩÆÊòæÁ§∫Â∞∫ÂØ∏
                    const maxWidth = 800;
                    const maxHeight = 600;
                    let displayWidth = canvasWidth;
                    let displayHeight = canvasHeight;
                    
                    if (displayWidth > maxWidth) {
                        displayHeight = (displayHeight * maxWidth) / displayWidth;
                        displayWidth = maxWidth;
                    }
                    
                    if (displayHeight > maxHeight) {
                        displayWidth = (displayWidth * maxHeight) / displayHeight;
                        displayHeight = maxHeight;
                    }
                    
                    canvas.style.width = displayWidth + 'px';
                    canvas.style.height = displayHeight + 'px';
                    
                    // Ê∏ÖÈô§canvas
                    ctx.clearRect(0, 0, canvasWidth, canvasHeight);
                    
                    // ÁªòÂà∂Êñ∞ÂõæÁâáÔºà‰øùÊåÅÂéüÊúâÂ∞∫ÂØ∏Ôºâ
                    ctx.globalAlpha = 1.0;
                    ctx.drawImage(img, 0, 0, canvasWidth, canvasHeight);
                    
                    // ‰øùÂ≠òÁä∂ÊÄÅÔºàËøôÊòØÂõæÁîªÂäüËÉΩÁöÑÂàùÂßãÁä∂ÊÄÅÔºâ
                    drawingHistory = [];
                    saveState();
                    
                    // Ê∏ÖÁ©∫mask canvasÔºàÂáÜÂ§áÁî®‰∫éÂõæÁîªÂäüËÉΩÔºâ
                    maskCtx.clearRect(0, 0, maskCanvas.width, maskCanvas.height);
                    
                    // Êõ¥Êñ∞‰∏ä‰º†ÁöÑÊñá‰ª∂ÂêçÔºà‰ΩøÁî®Êñ∞ÁöÑÊñá‰ª∂ÂêçÔºâ
                    if (filename) {
                        uploadedImageFile = filename;
                        console.log('Êõ¥Êñ∞‰∏ä‰º†ÁöÑÊñá‰ª∂Âêç:', uploadedImageFile);
                    }
                    
                    // ÊòæÁ§∫canvasÂÆπÂô®
                    const canvasContainer = document.getElementById('canvasContainer');
                    if (canvasContainer) {
                        canvasContainer.style.display = 'block';
                    }
                    
                    // Á°Æ‰øùcanvas cursorÂ∑≤ÂàùÂßãÂåñ
                    if (!canvasCursor) {
                        canvasCursor = document.getElementById('canvasCursor');
                    }
                    
                    console.log('Êì¶Èô§ÂêéÁöÑÂõæÁâáÂ∑≤ÊàêÂäüÂä†ËΩΩÂà∞ÂõæÁîªcanvasÔºåÂõæÁîªÂäüËÉΩÂ∑≤ÂáÜÂ§áÂ∞±Áª™');
                };
                
                // Áõ¥Êé•‰ΩøÁî®Â∑≤Âä†ËΩΩÁöÑimgÂØπË±°ÔºàÊì¶Èô§ÂêéÁöÑÂõæÁâáÔºâËÆæÁΩÆcanvas
                // ËøôÊ†∑Á°Æ‰øùcanvas‰ΩøÁî®ÁöÑÊòØÊì¶Èô§ÂêéÁöÑÂõæÁâáÔºåËÄå‰∏çÊòØ‰æùËµñpreviewImage.srcÔºàÂèØËÉΩÊúâÂª∂ËøüÊàñÁºìÂ≠òÈóÆÈ¢òÔºâ
                console.log('‰ΩøÁî®Â∑≤Âä†ËΩΩÁöÑÊì¶Èô§ÂêéÂõæÁâáËÆæÁΩÆcanvasÔºàimgÂØπË±°Ôºâ');
                setupDrawCanvas();
                
                // È¢ÑËßàÂõæÁâásrcÂ∑≤ÁªèÂú®‰∏äÈù¢Êõ¥Êñ∞‰∫ÜÔºåËøôÈáåÂè™ÊòØÁ°ÆËÆ§‰∏Ä‰∏ã
                console.log('È¢ÑËßàÂõæÁâásrcÂ∑≤Êõ¥Êñ∞ÔºåÂΩìÂâçÂÄº:', previewImage.src);
            };
            
            img.onerror = function() {
                console.error('Âä†ËΩΩÊì¶Èô§ÂêéÁöÑÂõæÁâáÂ§±Ë¥•ÔºåË∑ØÂæÑ:', fullImagePath);
                showMessage('Âä†ËΩΩÊì¶Èô§ÂêéÁöÑÂõæÁâáÂ§±Ë¥•ÔºåËØ∑Ê£ÄÊü•ÂõæÁâáË∑ØÂæÑ: ' + fullImagePath, 'error');
            };
            
            // Âä†ËΩΩÂõæÁâá
            img.src = fullImagePath;
        }
        
        // Ë∑≥ËøáÊì¶Èô§Ê≠•È™§
        function skipErase() {
            console.log('Ë∑≥ËøáÊì¶Èô§Ê≠•È™§ÔºåÁõ¥Êé•ËøõÂÖ•ÂõæÁîªÊ≠•È™§');
            
            // Á°Æ‰øùÈ¢ÑËßàÂõæÁâásrcÊ≠£Á°ÆËÆæÁΩÆ
            const previewImage = document.getElementById('previewImage');
            if (!previewImage || !previewImage.src) {
                console.error('È¢ÑËßàÂõæÁâá‰∏çÂ≠òÂú®ÔºåÊó†Ê≥ïË∑≥ËøáÊì¶Èô§');
                showMessage('ËØ∑ÂÖà‰∏ä‰º†ÂõæÁâá', 'error');
                return;
            }
            
            // Â¶ÇÊûúpreviewImage.srcÊòØbase64 data URLÔºåÈúÄË¶ÅÁ°Æ‰øùÂÆÉËÉΩÊ≠£Á°ÆÂä†ËΩΩ
            // Â¶ÇÊûúpreviewImage.srcÊòØÊúçÂä°Âô®Ë∑ØÂæÑÔºå‰πüÈúÄË¶ÅÁ°Æ‰øùË∑ØÂæÑÊ≠£Á°Æ
            console.log('skipErase: previewImage.src =', previewImage.src);
            console.log('skipErase: uploadedImageFile =', uploadedImageFile);
            
            // Â¶ÇÊûúpreviewImage.srcÊòØbase64 data URLÔºåÁõ¥Êé•‰ΩøÁî®
            // Â¶ÇÊûúÊòØÊúçÂä°Âô®Ë∑ØÂæÑÔºåÁ°Æ‰øùË∑ØÂæÑÊ≠£Á°Æ
            if (!previewImage.src.startsWith('data:')) {
                // Â¶ÇÊûúÊòØÊúçÂä°Âô®Ë∑ØÂæÑÔºåÁ°Æ‰øù‰ΩøÁî®Ê≠£Á°ÆÁöÑË∑ØÂæÑ
                // Â¶ÇÊûúuploadedImageFileÂ≠òÂú®ÔºåÂèØ‰ª•ÊûÑÂª∫Ê≠£Á°ÆÁöÑË∑ØÂæÑ
                if (uploadedImageFile) {
                    // Ê£ÄÊü•Ë∑ØÂæÑÊòØÂê¶Â∑≤ÁªèÊ≠£Á°Æ
                    const expectedPath = '/uploads/' + uploadedImageFile;
                    if (!previewImage.src.includes(uploadedImageFile)) {
                        console.log('Êõ¥Êñ∞È¢ÑËßàÂõæÁâáË∑ØÂæÑ‰∏∫:', expectedPath);
                        previewImage.src = expectedPath;
                    }
                }
            }
            
            activateStep(6);
            // ËÆæÁΩÆÂõæÁîªcanvas
            setTimeout(() => {
                setupCanvas();
            }, 100);
        }
        
        // ÁªëÂÆöÊì¶Èô§Áõ∏ÂÖ≥ÊåâÈíÆ‰∫ã‰ª∂
        document.addEventListener('DOMContentLoaded', function() {
            // ‰ΩøÁî®‰∫ã‰ª∂ÂßîÊâòÁªëÂÆöÊì¶Èô§ÊåâÈíÆ
            document.addEventListener('click', function(e) {
                if (e.target && e.target.id === 'eraseUndoBtn') {
                    e.preventDefault();
                    eraseUndo();
                }
                if (e.target && e.target.id === 'eraseClearBtn') {
                    e.preventDefault();
                    eraseClear();
                }
                if (e.target && e.target.id === 'startEraseBtn') {
                    e.preventDefault();
                    startErase();
                }
                if (e.target && e.target.id === 'skipEraseBtn') {
                    e.preventDefault();
                    skipErase();
                }
            });
            
            // ‰πüÂ∞ùËØïÁõ¥Êé•ÁªëÂÆö
            setTimeout(() => {
                const eraseUndoBtn = document.getElementById('eraseUndoBtn');
                const eraseClearBtn = document.getElementById('eraseClearBtn');
                const startEraseBtn = document.getElementById('startEraseBtn');
                const skipEraseBtn = document.getElementById('skipEraseBtn');
                
                if (eraseUndoBtn) {
                    eraseUndoBtn.addEventListener('click', eraseUndo);
                }
                if (eraseClearBtn) {
                    eraseClearBtn.addEventListener('click', eraseClear);
                }
                if (startEraseBtn) {
                    startEraseBtn.addEventListener('click', startErase);
                }
                if (skipEraseBtn) {
                    skipEraseBtn.addEventListener('click', skipErase);
                }
            }, 500);
        });
    </script>
</body>
</html>