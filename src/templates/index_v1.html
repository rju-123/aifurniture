<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Smart Decoration v1.0</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>ğŸ </text></svg>">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Microsoft YaHei', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .header p {
            font-size: 1.2em;
            opacity: 0.9;
        }

        .main-content {
            padding: 40px;
        }

        .step {
            margin-bottom: 40px;
            padding: 30px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            background: #fafafa;
        }

        .step.active {
            border-color: #667eea;
            background: #f8f9ff;
        }

        .step-title {
            font-size: 1.5em;
            color: #333;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
        }

        .step-number {
            background: #667eea;
            color: white;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 15px;
            font-weight: bold;
        }

        .upload-area {
            border: 3px dashed #ccc;
            border-radius: 10px;
            padding: 40px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .upload-area:hover {
            border-color: #667eea;
            background: #f8f9ff;
        }

        .upload-area.dragover {
            border-color: #667eea;
            background: #e8f0fe;
        }

        .furniture-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .furniture-item {
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            padding: 15px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .furniture-item:hover {
            border-color: #667eea;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .furniture-item.selected {
            border-color: #667eea;
            background: #f8f9ff;
        }

        .furniture-item img {
            width: 100%;
            height: 100px;
            object-fit: cover;
            border-radius: 5px;
            margin-bottom: 10px;
        }

        .canvas-container {
            position: relative;
            display: inline-block;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            overflow: hidden;
            margin: 20px 0;
        }

        #drawingCanvas {
            cursor: none; /* éšè—é»˜è®¤å…‰æ ‡ï¼Œæˆ‘ä»¬å°†è‡ªå®šä¹‰å…‰æ ‡ */
        }

        .canvas-cursor {
            position: absolute;
            border: 2px solid rgba(0, 123, 255, 0.8);
            border-radius: 50%;
            pointer-events: none;
            z-index: 10;
            background: rgba(0, 123, 255, 0.2);
            display: none;
        }

        .canvas-tools {
            margin: 20px 0;
            display: flex;
            gap: 15px;
            align-items: center;
            flex-wrap: wrap;
        }

        .tool-group {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .btn {
            background: #667eea;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 25px;
            cursor: pointer;
            font-size: 16px;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-block;
        }

        .btn:hover {
            background: #5a67d8;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }

        .btn:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .btn-secondary {
            background: #6c757d;
        }

        .btn-secondary:hover {
            background: #5a6268;
        }

        .btn-danger {
            background: #dc3545;
        }

        .btn-danger:hover {
            background: #c82333;
        }

        .brush-size {
            margin: 0 10px;
        }

        .brush-size input {
            width: 100px;
        }

        .progress-bar {
            width: 100%;
            height: 20px;
            background: #e0e0e0;
            border-radius: 10px;
            overflow: hidden;
            margin: 20px 0;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(45deg, #667eea, #764ba2);
            width: 0%;
            transition: width 0.3s ease;
        }

        .result-container {
            margin-top: 30px;
            text-align: center;
        }

        .result-image {
            max-width: 100%;
            border-radius: 10px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }

        .loading {
            display: none;
            text-align: center;
            padding: 40px;
        }

        .loading.show {
            display: block;
        }

        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .message {
            padding: 15px;
            border-radius: 5px;
            margin: 20px 0;
            display: none;
        }

        .message.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .message.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .message.show {
            display: block;
        }

        @media (max-width: 768px) {
            .main-content {
                padding: 20px;
            }
            
            .furniture-grid {
                grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
            }
            
            .canvas-tools {
                flex-direction: column;
                align-items: stretch;
            }
            
            .tool-group {
                justify-content: center;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ  AI Smart Decoration v1.0</h1>
            <p>Upload living room image, select furniture, draw placement area, generate decoration effect image with one click</p>
        </div>

        <div class="main-content">
            <!-- æ­¥éª¤1: ä¸Šä¼ å®¢å…å›¾ç‰‡ -->
            <div class="step active" id="step1">
                <div class="step-title">
                    <div class="step-number">1</div>
                    Upload Living Room Image
                </div>
                <div class="upload-area" id="uploadArea">
                    <div id="uploadContent">
                        <p>ğŸ“· Click or drag to upload living room image</p>
                        <p style="color: #666; margin-top: 10px;">Supports JPG, PNG, GIF formats, max 16MB</p>
                    </div>
                    <input type="file" id="fileInput" accept="image/*" style="display: none;">
                </div>
                <div id="uploadedImage" style="display: none; text-align: center; margin-top: 20px;">
                    <img id="previewImage" style="max-width: 100%; max-height: 400px; border-radius: 10px;">
                </div>
            </div>

            <!-- æ­¥éª¤2: è¯†åˆ«å®¢å…å°ºå¯¸ -->
            <div class="step" id="step2">
                <div class="step-title">
                    <div class="step-number">2</div>
                    Identify Living Room Dimensions
                </div>
                <div id="sizeDetectionArea">
                    <div class="loading" id="sizeLoading" style="display: none;">
                        <div class="spinner"></div>
                        <p>Identifying living room dimensions, please wait...</p>
                    </div>
                    <div id="sizeResult" style="display: none;">
                        <div style="background: #f0f8ff; padding: 20px; border-radius: 10px; margin: 20px 0;">
                            <h4 style="margin-bottom: 15px;">ğŸ“ Detected Living Room Dimensions:</h4>
                            <div id="estimatedBadge" style="display: none; background: #fff3cd; padding: 8px 15px; border-radius: 20px; margin-bottom: 15px; text-align: center; color: #856404; font-size: 0.9em;">
                                âš ï¸ This is an estimated value based on the image, please confirm or modify
                            </div>
                            <div style="display: flex; gap: 30px; justify-content: center; align-items: center; flex-wrap: wrap;">
                                <div>
                                    <label style="font-weight: bold; color: #667eea;">Length:</label>
                                    <span id="detectedLength" style="font-size: 1.2em; margin-left: 10px;">-</span>
                                    <span style="color: #666;">m</span>
                                </div>
                                <div>
                                    <label style="font-weight: bold; color: #667eea;">Width:</label>
                                    <span id="detectedWidth" style="font-size: 1.2em; margin-left: 10px;">-</span>
                                    <span style="color: #666;">m</span>
                                </div>
                            </div>
                            <div id="sofaSizeRange" style="display: none; margin-top: 20px; padding: 15px; background: #e8f5e9; border-radius: 10px;">
                                <h5 style="margin-bottom: 10px; color: #2e7d32;">ğŸ›‹ï¸ Suitable Sofa Size Range:</h5>
                                <div style="display: flex; gap: 30px; justify-content: center; flex-wrap: wrap; font-size: 0.95em;">
                                    <div>
                                        <label style="color: #666;">Length:</label>
                                        <span id="sofaLengthRange" style="font-weight: bold; color: #2e7d32;"></span>
                                        <span style="color: #666;">m</span>
                                    </div>
                                    <div>
                                        <label style="color: #666;">Width:</label>
                                        <span id="sofaWidthRange" style="font-weight: bold; color: #2e7d32;"></span>
                                        <span style="color: #666;">m</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div style="background: #fff3cd; padding: 15px; border-radius: 10px; margin: 20px 0;">
                            <p style="margin: 0; color: #856404;">
                                ğŸ’¡ If the recognition result is inaccurate, you can manually enter the correct dimensions:
                            </p>
                            <div style="display: flex; gap: 20px; margin-top: 15px; justify-content: center; align-items: center; flex-wrap: wrap;">
                                <div>
                                    <label>Length (m):</label>
                                    <input type="number" id="manualLength" step="0.1" min="0" style="padding: 8px; border: 1px solid #ddd; border-radius: 5px; width: 100px;">
                                </div>
                                <div>
                                    <label>Width (m):</label>
                                    <input type="number" id="manualWidth" step="0.1" min="0" style="padding: 8px; border: 1px solid #ddd; border-radius: 5px; width: 100px;">
                                </div>
                                <div>
                                    <button class="btn" id="confirmSizeBtnSuccess" onclick="confirmSizeModify()" style="margin-top: 10px; cursor: pointer;">Confirm Modification</button>
                                </div>
                            </div>
                            <p id="sizeInputErrorSuccess" style="color: #dc3545; margin-top: 10px; display: none; text-align: center;"></p>
                        </div>
                    </div>
                    <div id="sizeError" style="display: none; background: #f8d7da; padding: 15px; border-radius: 10px; color: #721c24;">
                        <p id="sizeErrorMessage"></p>
                        <div style="margin-top: 15px;">
                            <p style="margin-bottom: 10px;">Please manually enter living room dimensions:</p>
                            <div style="display: flex; gap: 20px; justify-content: center; align-items: center; flex-wrap: wrap;">
                                <div>
                                    <label>Length (m):</label>
                                    <input type="number" id="manualLengthError" step="0.1" min="0" style="padding: 8px; border: 1px solid #ddd; border-radius: 5px; width: 100px;">
                                </div>
                                <div>
                                    <label>Width (m):</label>
                                    <input type="number" id="manualWidthError" step="0.1" min="0" style="padding: 8px; border: 1px solid #ddd; border-radius: 5px; width: 100px;">
                                </div>
                                <div>
                                    <button class="btn" id="confirmSizeBtn" onclick="confirmSizeInput()" style="margin-top: 10px; cursor: pointer;">Confirm Dimensions</button>
                                </div>
                            </div>
                            <p id="sizeInputError" style="color: #dc3545; margin-top: 10px; display: none; text-align: center;"></p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- æ­¥éª¤3: é€‰æ‹©æ²™å‘é£æ ¼ -->
            <div class="step" id="step3">
                <div class="step-title">
                    <div class="step-number">3</div>
                    Select Sofa Style
                </div>
                <div id="styleSelectionArea">
                    <div id="styleButtonsContainer" style="display: flex; gap: 15px; flex-wrap: wrap; justify-content: center; margin: 20px 0;">
                        <button class="btn style-btn" data-style="modern">Modern Style</button>
                        <button class="btn style-btn" data-style="nordic">Nordic Style</button>
                        <button class="btn style-btn" data-style="european">European Style</button>
                        <button class="btn style-btn" data-style="chinese">Chinese Style</button>
                        <button class="btn style-btn" data-style="industrial">Industrial Style</button>
                        <button class="btn style-btn" data-style="minimalist">Minimalist Style</button>
                    </div>
                    <p id="selectedStyleText" style="text-align: center; color: #666; margin-top: 15px; display: none;">
                        Selected Style: <span id="selectedStyleName" style="font-weight: bold; color: #667eea;"></span>
                    </p>
                    <div id="furnitureLoading" style="display: none; text-align: center; margin-top: 20px;">
                        <div class="spinner" style="margin: 0 auto;"></div>
                        <p>Loading sofas...</p>
                    </div>
                </div>
            </div>

            <!-- æ­¥éª¤4: é€‰æ‹©æ²™å‘ -->
            <div class="step" id="step4">
                <div class="step-title">
                    <div class="step-number">4</div>
                    Select Sofa
                </div>
                <div id="furnitureGrid" class="furniture-grid">
                    <!-- å®¶å…·åˆ—è¡¨å°†é€šè¿‡JavaScriptåŠ¨æ€åŠ è½½ -->
                </div>
            </div>

            <!-- æ­¥éª¤5: æ¶‚ç”»æ”¾ç½®åŒºåŸŸ -->
            <div class="step" id="step5">
                <div class="step-title">
                    <div class="step-number">5</div>
                    Draw Furniture Placement Area
                </div>
                <div class="canvas-tools">
                    <div class="tool-group">
                        <label>Brush Size: 100px (Fixed)</label>
                    </div>
                    <div class="tool-group">
                        <label>Opacity: 40% (Fixed)</label>
                    </div>
                    <div class="tool-group">
                        <button class="btn btn-secondary" id="undoBtn">â†¶ Undo</button>
                        <button class="btn btn-danger" id="clearBtn">ğŸ—‘ï¸ Clear All</button>
                    </div>
                </div>
                <div class="canvas-container" id="canvasContainer" style="display: none;">
                    <canvas id="drawingCanvas"></canvas>
                    <div class="canvas-cursor" id="canvasCursor"></div>
                </div>
                <p style="color: #666; margin-top: 10px;">
                    ğŸ’¡ Tip: Use the brush to draw light blue areas on the living room image to mark the furniture placement location
                </p>
            </div>

            <!-- æ­¥éª¤6: ç”Ÿæˆæ•ˆæœå›¾ -->
            <div class="step" id="step6">
                <div class="step-title">
                    <div class="step-number">6</div>
                    Generate Decoration Effect Image
                </div>
                <button class="btn" id="generateBtn" disabled>ğŸ¨ Generate Decoration Effect Image</button>
                
                <div class="loading" id="loading">
                    <div class="spinner"></div>
                    <p>Generating decoration effect image, please wait...</p>
                </div>

                <div class="result-container" id="resultContainer">
                    <!-- ç”Ÿæˆçš„ç»“æœå°†æ˜¾ç¤ºåœ¨è¿™é‡Œ -->
                </div>
            </div>

            <!-- æ¶ˆæ¯æç¤º -->
            <div class="message" id="message"></div>
        </div>
    </div>

    <script>
        // å…¨å±€å˜é‡
        let uploadedImageFile = null;
        let selectedFurniture = null;
        let canvas = null;
        let ctx = null;
        let isDrawing = false;
        let drawingHistory = [];
        let currentStep = 1;
        let canvasCursor = null;
        let maskCanvas = null; // ç”¨äºå­˜å‚¨maskå›¾å±‚çš„ä¸´æ—¶canvas
        let maskCtx = null;
        let roomLength = null; // å®¢å…é•¿åº¦ï¼ˆç±³ï¼‰
        let roomWidth = null;  // å®¢å…å®½åº¦ï¼ˆç±³ï¼‰
        let selectedStyle = null; // é€‰ä¸­çš„æ²™å‘é£æ ¼

        // åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            initializeUpload();
            initializeCanvas();
            initializeButtons();
            initializeStyleSelection();
            initializeSizeButtons();
        });
        
        // åˆå§‹åŒ–å°ºå¯¸ç¡®è®¤æŒ‰é’®ï¼ˆä½¿ç”¨äº‹ä»¶å§”æ‰˜ï¼Œç¡®ä¿åŠ¨æ€å…ƒç´ ä¹Ÿèƒ½å“åº”ï¼‰
        function initializeSizeButtons() {
            // ä½¿ç”¨äº‹ä»¶å§”æ‰˜ï¼Œç›‘å¬æ•´ä¸ªæ–‡æ¡£çš„ç‚¹å‡»äº‹ä»¶ï¼ˆä½œä¸ºå¤‡é€‰æ–¹æ¡ˆï¼‰
            document.addEventListener('click', function(e) {
                // ç¡®è®¤å°ºå¯¸æŒ‰é’®ï¼ˆè¯†åˆ«å¤±è´¥æ—¶ï¼‰
                if (e.target && e.target.id === 'confirmSizeBtn') {
                    e.preventDefault();
                    e.stopPropagation();
                    console.log('äº‹ä»¶å§”æ‰˜æ•è·åˆ°ç¡®è®¤å°ºå¯¸æŒ‰é’®ç‚¹å‡»');
                    confirmSizeInput();
                }
                // ç¡®è®¤ä¿®æ”¹æŒ‰é’®ï¼ˆè¯†åˆ«æˆåŠŸæ—¶ï¼‰
                if (e.target && e.target.id === 'confirmSizeBtnSuccess') {
                    e.preventDefault();
                    e.stopPropagation();
                    console.log('äº‹ä»¶å§”æ‰˜æ•è·åˆ°ç¡®è®¤ä¿®æ”¹æŒ‰é’®ç‚¹å‡»');
                    confirmSizeModify();
                }
            });
            
            // ä¹Ÿå°è¯•ç›´æ¥ç»‘å®šï¼ˆå¦‚æœå…ƒç´ å·²å­˜åœ¨ï¼‰
            setTimeout(() => {
                const confirmBtn = document.getElementById('confirmSizeBtn');
                const confirmBtnSuccess = document.getElementById('confirmSizeBtnSuccess');
                
                if (confirmBtn) {
                    console.log('æ‰¾åˆ°ç¡®è®¤å°ºå¯¸æŒ‰é’®ï¼Œç›´æ¥ç»‘å®šäº‹ä»¶');
                    confirmBtn.addEventListener('click', function(e) {
                        e.preventDefault();
                        e.stopPropagation();
                        console.log('ç›´æ¥ç»‘å®šçš„äº‹ä»¶è§¦å‘');
                        confirmSizeInput();
                    });
                }
                
                if (confirmBtnSuccess) {
                    console.log('æ‰¾åˆ°ç¡®è®¤ä¿®æ”¹æŒ‰é’®ï¼Œç›´æ¥ç»‘å®šäº‹ä»¶');
                    confirmBtnSuccess.addEventListener('click', function(e) {
                        e.preventDefault();
                        e.stopPropagation();
                        console.log('ç›´æ¥ç»‘å®šçš„äº‹ä»¶è§¦å‘');
                        confirmSizeModify();
                    });
                }
            }, 500);
        }

        // åˆå§‹åŒ–ä¸Šä¼ åŠŸèƒ½
        function initializeUpload() {
            const uploadArea = document.getElementById('uploadArea');
            const fileInput = document.getElementById('fileInput');

            uploadArea.addEventListener('click', () => fileInput.click());
            uploadArea.addEventListener('dragover', handleDragOver);
            uploadArea.addEventListener('drop', handleDrop);
            fileInput.addEventListener('change', handleFileSelect);
        }

        function handleDragOver(e) {
            e.preventDefault();
            e.currentTarget.classList.add('dragover');
        }

        function handleDrop(e) {
            e.preventDefault();
            e.currentTarget.classList.remove('dragover');
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                handleFile(files[0]);
            }
        }

        function handleFileSelect(e) {
            const file = e.target.files[0];
            if (file) {
                handleFile(file);
            }
        }

        function handleFile(file) {
            if (!file.type.startsWith('image/')) {
                showMessage('Please select an image file', 'error');
                return;
            }

            // æ˜¾ç¤ºé¢„è§ˆ
            const reader = new FileReader();
            reader.onload = function(e) {
                const previewImage = document.getElementById('previewImage');
                previewImage.src = e.target.result;
                document.getElementById('uploadedImage').style.display = 'block';
                
                // ä¸Šä¼ æ–‡ä»¶
                uploadFile(file);
            };
            reader.readAsDataURL(file);
        }

        function uploadFile(file) {
            const formData = new FormData();
            formData.append('file', file);

            // æ˜¾ç¤ºä¸Šä¼ å’Œè¯†åˆ«ä¸­çš„çŠ¶æ€
            const sizeLoading = document.getElementById('sizeLoading');
            if (sizeLoading) {
                sizeLoading.style.display = 'block';
            }

            fetch('/upload', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    uploadedImageFile = data.filename;
                    showMessage('Living room image uploaded successfully, identifying dimensions...', 'success');
                    
                    // å¤„ç†å°ºå¯¸è¯†åˆ«ç»“æœ
                    if (data.size_detection) {
                        handleSizeDetection(data.size_detection);
                    } else {
                        // å¦‚æœæ²¡æœ‰å°ºå¯¸è¯†åˆ«ç»“æœï¼Œç›´æ¥è¿›å…¥ä¸‹ä¸€æ­¥
                        if (sizeLoading) {
                            sizeLoading.style.display = 'none';
                        }
                        activateStep(2);
                    }
                } else {
                    if (sizeLoading) {
                        sizeLoading.style.display = 'none';
                    }
                    showMessage(data.error || 'Upload failed', 'error');
                }
            })
            .catch(error => {
                if (sizeLoading) {
                    sizeLoading.style.display = 'none';
                }
                showMessage('Upload failed: ' + error.message, 'error');
            });
        }

        // è®¡ç®—é€‚åˆæ‘†æ”¾æ²™å‘çš„å°ºå¯¸èŒƒå›´ï¼ˆä¸åç«¯å…¬å¼ä¸€è‡´ï¼‰
        function calculateSofaSizeRange(roomLength, roomWidth) {
            // æ²™å‘é•¿åº¦ï¼šæœ€å¤§å€¼ = å®¢å…é•¿åº¦ Ã— 0.6ï¼Œä½†ä¸è¶…è¿‡ 3.5ç±³
            //           æœ€å°å€¼ = å®¢å…é•¿åº¦ Ã— 0.3ï¼Œä½†ä¸å°äº 1ç±³
            const sofaLengthMax = Math.min(roomLength * 0.6, 3.5);
            const sofaLengthMin = Math.max(roomLength * 0.3, 1.0);
            
            // æ²™å‘å®½åº¦ï¼šæœ€å¤§å€¼ = å®¢å…å®½åº¦ Ã— 0.3ï¼Œä½†ä¸è¶…è¿‡ 1ç±³
            //           æœ€å°å€¼ = å®¢å…å®½åº¦ Ã— 0.2ï¼Œä½†ä¸è¶…è¿‡ 0.7ç±³
            const sofaWidthMax = Math.min(roomWidth * 0.3, 1.0);
            const sofaWidthMin = Math.min(roomWidth * 0.2, 0.7);
            
            return {
                length: {
                    min: parseFloat(sofaLengthMin.toFixed(2)),
                    max: parseFloat(sofaLengthMax.toFixed(2))
                },
                width: {
                    min: parseFloat(sofaWidthMin.toFixed(2)),
                    max: parseFloat(sofaWidthMax.toFixed(2))
                }
            };
        }
        
        // æ›´æ–°æ²™å‘å°ºå¯¸èŒƒå›´æ˜¾ç¤º
        function updateSofaSizeRangeDisplay(roomLength, roomWidth) {
            const sofaRange = calculateSofaSizeRange(roomLength, roomWidth);
            const sofaSizeRange = document.getElementById('sofaSizeRange');
            const sofaLengthRange = document.getElementById('sofaLengthRange');
            const sofaWidthRange = document.getElementById('sofaWidthRange');
            
            if (sofaSizeRange) {
                sofaSizeRange.style.display = 'block';
            }
            if (sofaLengthRange) {
                sofaLengthRange.textContent = `${sofaRange.length.min} - ${sofaRange.length.max}`;
            }
            if (sofaWidthRange) {
                sofaWidthRange.textContent = `${sofaRange.width.min} - ${sofaRange.width.max}`;
            }
            
            console.log('æ²™å‘å°ºå¯¸èŒƒå›´å·²æ›´æ–°:', sofaRange);
        }

        // å°†å‡½æ•°æš´éœ²åˆ°å…¨å±€ä½œç”¨åŸŸï¼Œä»¥ä¾¿onclickå¯ä»¥è®¿é—®
        window.confirmSizeInput = function() {
            console.log('=== confirmSizeInput è¢«è°ƒç”¨ ===');
            const lengthInput = document.getElementById('manualLengthError');
            const widthInput = document.getElementById('manualWidthError');
            const errorMsg = document.getElementById('sizeInputError');
            
            console.log('lengthInput:', lengthInput);
            console.log('widthInput:', widthInput);
            
            if (!lengthInput || !widthInput) {
                console.error('æ‰¾ä¸åˆ°è¾“å…¥æ¡†å…ƒç´ ');
                showMessage('System error: Input fields not found', 'error');
                return false;
            }
            
            const length = parseFloat(lengthInput.value);
            const width = parseFloat(widthInput.value);
            
            console.log('è¾“å…¥çš„å°ºå¯¸ - é•¿åº¦:', length, 'å®½åº¦:', width);
            console.log('é•¿åº¦å€¼ç±»å‹:', typeof length, 'æ˜¯å¦NaN:', isNaN(length));
            console.log('å®½åº¦å€¼ç±»å‹:', typeof width, 'æ˜¯å¦NaN:', isNaN(width));
            
            // éªŒè¯è¾“å…¥
            if (!length || length <= 0 || isNaN(length)) {
                console.warn('é•¿åº¦éªŒè¯å¤±è´¥');
                if (errorMsg) {
                    errorMsg.textContent = 'Please enter a valid length (greater than 0)';
                    errorMsg.style.display = 'block';
                }
                showMessage('Please enter a valid length (greater than 0)', 'error');
                return false;
            }
            if (!width || width <= 0 || isNaN(width)) {
                console.warn('å®½åº¦éªŒè¯å¤±è´¥');
                if (errorMsg) {
                    errorMsg.textContent = 'Please enter a valid width (greater than 0)';
                    errorMsg.style.display = 'block';
                }
                showMessage('Please enter a valid width (greater than 0)', 'error');
                return false;
            }
            
            // ä¿å­˜å°ºå¯¸
            roomLength = length;
            roomWidth = width;
            if (errorMsg) {
                errorMsg.style.display = 'none';
            }
            
            // æ›´æ–°æ²™å‘å°ºå¯¸èŒƒå›´æ˜¾ç¤º
            updateSofaSizeRangeDisplay(length, width);
            
            console.log('âœ“ å°ºå¯¸å·²ä¿å­˜ - é•¿åº¦:', roomLength, 'å®½åº¦:', roomWidth);
            showMessage(`Dimensions confirmed: Length=${length.toFixed(2)}m, Width=${width.toFixed(2)}m`, 'success');
            
            // è‡ªåŠ¨è¿›å…¥ä¸‹ä¸€æ­¥
            setTimeout(() => {
                console.log('è¿›å…¥æ­¥éª¤3');
                activateStep(3);
            }, 500);
            
            return false; // é˜²æ­¢è¡¨å•æäº¤
        };
        
        // ä¿ç•™åŸæ¥çš„å‡½æ•°å®šä¹‰ï¼ˆå‘åå…¼å®¹ï¼‰
        function confirmSizeInput() {
            return window.confirmSizeInput();
        }

        // å°†å‡½æ•°æš´éœ²åˆ°å…¨å±€ä½œç”¨åŸŸ
        window.confirmSizeModify = function() {
            console.log('=== confirmSizeModify è¢«è°ƒç”¨ ===');
            const lengthInput = document.getElementById('manualLength');
            const widthInput = document.getElementById('manualWidth');
            const errorMsg = document.getElementById('sizeInputErrorSuccess');
            
            console.log('lengthInput:', lengthInput);
            console.log('widthInput:', widthInput);
            
            if (!lengthInput || !widthInput) {
                console.error('æ‰¾ä¸åˆ°è¾“å…¥æ¡†å…ƒç´ ');
                showMessage('System error: Input fields not found', 'error');
                return false;
            }
            
            const length = parseFloat(lengthInput.value);
            const width = parseFloat(widthInput.value);
            
            console.log('è¾“å…¥çš„å°ºå¯¸ - é•¿åº¦:', length, 'å®½åº¦:', width);
            
            // éªŒè¯è¾“å…¥
            if (!length || length <= 0 || isNaN(length)) {
                console.warn('é•¿åº¦éªŒè¯å¤±è´¥');
                if (errorMsg) {
                    errorMsg.textContent = 'Please enter a valid length (greater than 0)';
                    errorMsg.style.display = 'block';
                }
                showMessage('Please enter a valid length (greater than 0)', 'error');
                return false;
            }
            if (!width || width <= 0 || isNaN(width)) {
                console.warn('å®½åº¦éªŒè¯å¤±è´¥');
                if (errorMsg) {
                    errorMsg.textContent = 'Please enter a valid width (greater than 0)';
                    errorMsg.style.display = 'block';
                }
                showMessage('Please enter a valid width (greater than 0)', 'error');
                return false;
            }
            
            // ä¿å­˜å°ºå¯¸å¹¶æ›´æ–°æ˜¾ç¤º
            roomLength = length;
            roomWidth = width;
            
            const detectedLengthEl = document.getElementById('detectedLength');
            const detectedWidthEl = document.getElementById('detectedWidth');
            
            if (detectedLengthEl) {
                detectedLengthEl.textContent = length.toFixed(2);
            }
            if (detectedWidthEl) {
                detectedWidthEl.textContent = width.toFixed(2);
            }
            if (errorMsg) {
                errorMsg.style.display = 'none';
            }
            
            // æ›´æ–°æ²™å‘å°ºå¯¸èŒƒå›´æ˜¾ç¤º
            updateSofaSizeRangeDisplay(length, width);
            
            console.log('âœ“ å°ºå¯¸å·²æ›´æ–° - é•¿åº¦:', roomLength, 'å®½åº¦:', roomWidth);
            showMessage(`Dimensions updated: Length=${length.toFixed(2)}m, Width=${width.toFixed(2)}m, sofa size range automatically updated`, 'success');
            
            return false; // é˜²æ­¢è¡¨å•æäº¤
        };
        
        // ä¿ç•™åŸæ¥çš„å‡½æ•°å®šä¹‰ï¼ˆå‘åå…¼å®¹ï¼‰
        function confirmSizeModify() {
            return window.confirmSizeModify();
        }

        function handleSizeDetection(sizeResult) {
            console.log('å¤„ç†å°ºå¯¸è¯†åˆ«ç»“æœ:', sizeResult);
            
            const sizeLoading = document.getElementById('sizeLoading');
            const sizeResultDiv = document.getElementById('sizeResult');
            const sizeError = document.getElementById('sizeError');
            
            sizeLoading.style.display = 'none';
            
            if (sizeResult.success) {
                // è¯†åˆ«æˆåŠŸï¼ˆå¯èƒ½æ˜¯ä¼°ç®—å€¼ï¼‰
                roomLength = sizeResult.length;
                roomWidth = sizeResult.width;
                
                document.getElementById('detectedLength').textContent = roomLength.toFixed(2);
                document.getElementById('detectedWidth').textContent = roomWidth.toFixed(2);
                
                // è®¾ç½®æ‰‹åŠ¨è¾“å…¥æ¡†çš„é»˜è®¤å€¼
                document.getElementById('manualLength').value = roomLength.toFixed(2);
                document.getElementById('manualWidth').value = roomWidth.toFixed(2);
                
                // æ˜¾ç¤ºä¼°ç®—å€¼æç¤º
                const estimatedBadge = document.getElementById('estimatedBadge');
                if (sizeResult.is_estimated) {
                    if (estimatedBadge) {
                        estimatedBadge.style.display = 'block';
                    }
                    showMessage('Room dimensions estimated based on image, please confirm or modify', 'success');
                } else {
                    if (estimatedBadge) {
                        estimatedBadge.style.display = 'none';
                    }
                    showMessage('Living room dimensions identified successfully, you can continue or modify dimensions', 'success');
                }
                
                // æ˜¾ç¤ºé€‚åˆæ‘†æ”¾æ²™å‘çš„å°ºå¯¸èŒƒå›´
                if (sizeResult.sofa_length_range && sizeResult.sofa_width_range) {
                    const sofaSizeRange = document.getElementById('sofaSizeRange');
                    const sofaLengthRange = document.getElementById('sofaLengthRange');
                    const sofaWidthRange = document.getElementById('sofaWidthRange');
                    
                    if (sofaSizeRange) {
                        sofaSizeRange.style.display = 'block';
                    }
                    if (sofaLengthRange) {
                        sofaLengthRange.textContent = `${sizeResult.sofa_length_range.min} - ${sizeResult.sofa_length_range.max}`;
                    }
                    if (sofaWidthRange) {
                        sofaWidthRange.textContent = `${sizeResult.sofa_width_range.min} - ${sizeResult.sofa_width_range.max}`;
                    }
                    
                    console.log('æ²™å‘å°ºå¯¸èŒƒå›´:', sizeResult.sofa_length_range, sizeResult.sofa_width_range);
                }
                
                sizeResultDiv.style.display = 'block';
                sizeError.style.display = 'none';
                
                // è‡ªåŠ¨è¿›å…¥ä¸‹ä¸€æ­¥ï¼ˆç»™ç”¨æˆ·ä¸€ç‚¹æ—¶é—´æŸ¥çœ‹ç»“æœï¼‰
                setTimeout(() => {
                    activateStep(3);
                }, 1500);
            } else {
                // è¯†åˆ«å¤±è´¥ï¼Œæ˜¾ç¤ºé”™è¯¯ä¿¡æ¯å’Œæ‰‹åŠ¨è¾“å…¥
                document.getElementById('sizeErrorMessage').textContent = sizeResult.error || 'Unable to automatically identify dimensions';
                sizeError.style.display = 'block';
                sizeResultDiv.style.display = 'none';
            }
        }

        // åˆå§‹åŒ–é£æ ¼é€‰æ‹©ï¼ˆä½¿ç”¨äº‹ä»¶å§”æ‰˜ï¼‰
        function initializeStyleSelection() {
            // ä½¿ç”¨äº‹ä»¶å§”æ‰˜ï¼Œç¡®ä¿åŠ¨æ€åŠ è½½çš„å…ƒç´ ä¹Ÿèƒ½å“åº”
            document.addEventListener('click', function(e) {
                // æ£€æŸ¥æ˜¯å¦ç‚¹å‡»äº†é£æ ¼æŒ‰é’®
                if (e.target && e.target.classList.contains('style-btn')) {
                    const btn = e.target;
                    
                    // æ£€æŸ¥æ˜¯å¦å·²è¾“å…¥æˆ¿é—´å°ºå¯¸
                    if (!roomLength || !roomWidth) {
                        showMessage('Please confirm living room dimensions first', 'error');
                        activateStep(2);
                        return;
                    }
                    
                    // ç§»é™¤å…¶ä»–æŒ‰é’®çš„é€‰ä¸­çŠ¶æ€
                    const allStyleButtons = document.querySelectorAll('.style-btn');
                    allStyleButtons.forEach(b => {
                        b.style.opacity = '1';
                        b.style.transform = 'scale(1)';
                        b.style.background = '#667eea';
                        b.style.border = 'none';
                    });
                    
                    // é€‰ä¸­å½“å‰æŒ‰é’®
                    btn.style.opacity = '1';
                    btn.style.transform = 'scale(0.95)';
                    btn.style.background = '#764ba2';
                    btn.style.border = '2px solid #764ba2';
                    
                    selectedStyle = btn.getAttribute('data-style');
                    const styleName = btn.textContent.trim();
                    
                    const selectedStyleNameEl = document.getElementById('selectedStyleName');
                    const selectedStyleTextEl = document.getElementById('selectedStyleText');
                    
                    if (selectedStyleNameEl) {
                        selectedStyleNameEl.textContent = styleName;
                    }
                    if (selectedStyleTextEl) {
                        selectedStyleTextEl.style.display = 'block';
                    }
                    
                    showMessage(`Style selected: ${styleName}, loading sofas...`, 'success');
                    
                    // åŠ è½½å¯¹åº”é£æ ¼çš„æ²™å‘
                    loadFurnitureList(selectedStyle);
                    activateStep(4);
                }
            });
        }

        // åŠ è½½å®¶å…·åˆ—è¡¨ï¼ˆæ ¹æ®é£æ ¼å’Œå°ºå¯¸è¿‡æ»¤ï¼‰
        function loadFurnitureList(style = null) {
            let url = '/furniture?';
            if (style) {
                url += `style=${style}&`;
            }
            if (roomLength && roomWidth) {
                url += `room_length=${roomLength}&room_width=${roomWidth}&`;
            }
            
            fetch(url)
            .then(response => response.json())
            .then(data => {
                if (data.furniture) {
                    if (data.furniture.length === 0) {
                        showMessage('No sofas found matching the requirements, please try another style', 'error');
                    } else {
                        displayFurnitureList(data.furniture);
                    }
                } else {
                    showMessage('Failed to load furniture list', 'error');
                }
            })
            .catch(error => {
                showMessage('Failed to load furniture list: ' + error.message, 'error');
            });
        }

        function displayFurnitureList(furnitureList) {
            const grid = document.getElementById('furnitureGrid');
            grid.innerHTML = '';

            furnitureList.forEach(furniture => {
                const item = document.createElement('div');
                item.className = 'furniture-item';
                item.innerHTML = `
                    <img src="${furniture.path}" alt="${furniture.display_name || furniture.name}">
                    <div>${furniture.display_name || furniture.name}</div>
                `;
                
                item.addEventListener('click', () => selectFurniture(furniture, item));
                grid.appendChild(item);
            });
        }

        function selectFurniture(furniture, element) {
            console.log('é€‰æ‹©å®¶å…·:', furniture);
            
            // æ¸…é™¤ä¹‹å‰çš„é€‰æ‹©
            document.querySelectorAll('.furniture-item').forEach(item => {
                item.classList.remove('selected');
            });
            
            // é€‰æ‹©å½“å‰å®¶å…·
            element.classList.add('selected');
            selectedFurniture = furniture;
            
            showMessage(`Furniture selected: ${furniture.display_name || furniture.name}`, 'success');
            
            // è¿›å…¥æ­¥éª¤5ï¼ˆæ¶‚ç”»æ”¾ç½®åŒºåŸŸï¼‰
            console.log('è¿›å…¥æ­¥éª¤5 - æ¶‚ç”»æ”¾ç½®åŒºåŸŸ');
            activateStep(5);
            
            // å»¶è¿Ÿä¸€ç‚¹æ—¶é—´å†è®¾ç½®canvasï¼Œç¡®ä¿DOMå·²æ›´æ–°
            setTimeout(() => {
                setupCanvas();
            }, 100);
        }

        // åˆå§‹åŒ–ç”»å¸ƒï¼ˆå»¶è¿Ÿåˆå§‹åŒ–ï¼Œåªåœ¨éœ€è¦æ—¶åˆå§‹åŒ–ï¼‰
        function initializeCanvas() {
            canvas = document.getElementById('drawingCanvas');
            
            // å¦‚æœcanvaså…ƒç´ ä¸å­˜åœ¨ï¼Œå»¶è¿Ÿåˆå§‹åŒ–
            if (!canvas) {
                console.log('Canvaså…ƒç´ å°šæœªåŠ è½½ï¼Œå°†åœ¨éœ€è¦æ—¶åˆå§‹åŒ–');
                return;
            }
            
            try {
                ctx = canvas.getContext('2d');
                canvasCursor = document.getElementById('canvasCursor');
                
                // åˆ›å»ºmaskå›¾å±‚canvas
                maskCanvas = document.createElement('canvas');
                maskCtx = maskCanvas.getContext('2d');
                
                // è®¾ç½®ç”»ç¬”æ ·å¼
                ctx.globalCompositeOperation = 'source-over';
                ctx.lineCap = 'round';
                ctx.lineJoin = 'round';
                ctx.globalAlpha = 1.0; // åˆå§‹é€æ˜åº¦ä¸º1
                
                // ç»‘å®šäº‹ä»¶
                canvas.addEventListener('mousedown', startDrawing);
                canvas.addEventListener('mousemove', handleMouseMove);
                canvas.addEventListener('mouseup', stopDrawing);
                canvas.addEventListener('mouseout', hideCanvasCursor);
                canvas.addEventListener('mouseenter', showCanvasCursor);
                
                // è§¦æ‘¸äº‹ä»¶æ”¯æŒ
                canvas.addEventListener('touchstart', handleTouch);
                canvas.addEventListener('touchmove', handleTouch);
                canvas.addEventListener('touchend', stopDrawing);
                
                console.log('Canvasåˆå§‹åŒ–æˆåŠŸ');
            } catch (error) {
                console.error('Canvasåˆå§‹åŒ–å¤±è´¥:', error);
            }
        }

        function setupCanvas() {
            if (!uploadedImageFile) return;
            
            // ç¡®ä¿canvaså·²åˆå§‹åŒ–
            if (!canvas || !ctx) {
                initializeCanvas();
            }
            
            // å¦‚æœä»ç„¶æ— æ³•åˆå§‹åŒ–ï¼Œè¯´æ˜canvaså…ƒç´ ä¸å­˜åœ¨
            if (!canvas || !ctx) {
                console.error('æ— æ³•åˆå§‹åŒ–canvasï¼Œå…ƒç´ å¯èƒ½ä¸å­˜åœ¨');
                showMessage('Unable to initialize canvas, please refresh the page and try again', 'error');
                return;
            }
            
            const previewImage = document.getElementById('previewImage');
            const canvasContainer = document.getElementById('canvasContainer');
            
            // è®¾ç½®ç”»å¸ƒå°ºå¯¸
            canvas.width = previewImage.naturalWidth;
            canvas.height = previewImage.naturalHeight;
            
            // è®¾ç½®mask canvaså°ºå¯¸
            if (!maskCanvas || !maskCtx) {
                maskCanvas = document.createElement('canvas');
                maskCtx = maskCanvas.getContext('2d');
            }
            maskCanvas.width = canvas.width;
            maskCanvas.height = canvas.height;
            
            // è®¾ç½®æ˜¾ç¤ºå°ºå¯¸
            const maxWidth = 800;
            const maxHeight = 600;
            let displayWidth = canvas.width;
            let displayHeight = canvas.height;
            
            if (displayWidth > maxWidth) {
                displayHeight = (displayHeight * maxWidth) / displayWidth;
                displayWidth = maxWidth;
            }
            
            if (displayHeight > maxHeight) {
                displayWidth = (displayWidth * maxHeight) / displayHeight;
                displayHeight = maxHeight;
            }
            
            canvas.style.width = displayWidth + 'px';
            canvas.style.height = displayHeight + 'px';
            
            // ç»˜åˆ¶èƒŒæ™¯å›¾ç‰‡
            const img = new Image();
            img.onload = function() {
                ctx.globalAlpha = 1.0; // ç¡®ä¿èƒŒæ™¯å›¾ç‰‡å®Œå…¨ä¸é€æ˜
                ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                saveState();
                
                // æ¸…ç©ºmask canvas
                maskCtx.clearRect(0, 0, maskCanvas.width, maskCanvas.height);
            };
            img.src = previewImage.src;
            
            canvasContainer.style.display = 'block';
        }

        function updateCanvasCursor(e) {
            if (!canvasCursor) return;
            
            const rect = canvas.getBoundingClientRect();
            const brushSize = 100; // å›ºå®šç”»ç¬”å¤§å°100px
            
            // æ›´æ–°å…‰æ ‡ä½ç½®å’Œå¤§å°
            const cursorSize = brushSize * (rect.width / canvas.width); // æ ¹æ®canvasç¼©æ”¾è°ƒæ•´å…‰æ ‡å¤§å°
            canvasCursor.style.width = cursorSize + 'px';
            canvasCursor.style.height = cursorSize + 'px';
            canvasCursor.style.left = (e.clientX - rect.left - cursorSize/2) + 'px';
            canvasCursor.style.top = (e.clientY - rect.top - cursorSize/2) + 'px';
            
            // æ›´æ–°å…‰æ ‡é€æ˜åº¦é¢„è§ˆ (å›ºå®š40%é€æ˜åº¦)
            canvasCursor.style.background = `rgba(0, 123, 255, 0.12)`; // 40% * 0.3 = 0.12
        }

        function showCanvasCursor() {
            if (canvasCursor) {
                canvasCursor.style.display = 'block';
            }
        }

        function hideCanvasCursor() {
            if (canvasCursor) {
                canvasCursor.style.display = 'none';
            }
        }

        function handleMouseMove(e) {
            updateCanvasCursor(e);
            if (isDrawing) {
                drawCircle(e);
            }
        }

        function startDrawing(e) {
            isDrawing = true;
            saveState();
            drawCircle(e);
        }

        function drawCircle(e) {
            if (!isDrawing) return;
            
            const rect = canvas.getBoundingClientRect();
            const scaleX = canvas.width / rect.width;
            const scaleY = canvas.height / rect.height;
            
            const x = (e.clientX - rect.left) * scaleX;
            const y = (e.clientY - rect.top) * scaleY;
            const brushSize = 100; // å›ºå®šç”»ç¬”å¤§å°100px
            const radius = brushSize / 2;
            
            // åœ¨mask canvasä¸Šç»˜åˆ¶ä¸é€æ˜çš„è“è‰²
            maskCtx.globalCompositeOperation = 'source-over';
            maskCtx.globalAlpha = 1.0; // maskä¸Šå§‹ç»ˆä¸é€æ˜
            maskCtx.fillStyle = 'rgb(0, 123, 255)';
            
            maskCtx.beginPath();
            maskCtx.arc(x, y, radius, 0, 2 * Math.PI);
            maskCtx.fill();
            
            // é‡æ–°ç»˜åˆ¶æ•´ä¸ªcanvas
            redrawCanvas();
        }

        function redrawCanvas() {
            // æ¸…é™¤ä¸»canvas
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            // é‡æ–°ç»˜åˆ¶èƒŒæ™¯å›¾ç‰‡
            if (drawingHistory.length > 0) {
                ctx.putImageData(drawingHistory[0], 0, 0);
            }
            
            // ä»¥å›ºå®š40%é€æ˜åº¦ç»˜åˆ¶mask
            ctx.globalAlpha = 0.4; // å›ºå®š40%é€æ˜åº¦
            ctx.drawImage(maskCanvas, 0, 0);
            ctx.globalAlpha = 1.0; // æ¢å¤é€æ˜åº¦
        }

        function stopDrawing() {
            if (isDrawing) {
                isDrawing = false;
                ctx.globalAlpha = 1.0; // æ¢å¤é€æ˜åº¦
                checkCanGenerate();
            }
        }

        function handleTouch(e) {
            e.preventDefault();
            const touch = e.touches[0];
            const mouseEvent = new MouseEvent(e.type === 'touchstart' ? 'mousedown' : 
                                            e.type === 'touchmove' ? 'mousemove' : 'mouseup', {
                clientX: touch.clientX,
                clientY: touch.clientY
            });
            
            if (e.type === 'touchstart') {
                startDrawing(mouseEvent);
            } else if (e.type === 'touchmove') {
                handleMouseMove(mouseEvent);
            } else if (e.type === 'touchend') {
                stopDrawing();
            }
        }

        function saveState() {
            drawingHistory.push(ctx.getImageData(0, 0, canvas.width, canvas.height));
            if (drawingHistory.length > 20) {
                drawingHistory.shift();
            }
        }

        function undo() {
            if (drawingHistory.length > 1) {
                drawingHistory.pop();
                const previousState = drawingHistory[drawingHistory.length - 1];
                ctx.putImageData(previousState, 0, 0);
            }
        }

        function clearCanvas() {
            if (drawingHistory.length > 0) {
                const originalState = drawingHistory[0];
                ctx.putImageData(originalState, 0, 0);
                drawingHistory = [originalState];
                
                // æ¸…ç©ºmask canvas
                maskCtx.clearRect(0, 0, maskCanvas.width, maskCanvas.height);
            }
        }

        // åˆå§‹åŒ–æŒ‰é’®äº‹ä»¶ï¼ˆå»¶è¿Ÿåˆå§‹åŒ–ï¼Œåªåœ¨å…ƒç´ å­˜åœ¨æ—¶ç»‘å®šï¼‰
        function initializeButtons() {
            // ä½¿ç”¨äº‹ä»¶å§”æ‰˜ï¼Œé¿å…å…ƒç´ ä¸å­˜åœ¨çš„é—®é¢˜
            document.addEventListener('click', function(e) {
                // æ’¤é”€æŒ‰é’®
                if (e.target && e.target.id === 'undoBtn') {
                    e.preventDefault();
                    undo();
                }
                // æ¸…é™¤æŒ‰é’®
                if (e.target && e.target.id === 'clearBtn') {
                    e.preventDefault();
                    clearCanvas();
                }
                // ç”ŸæˆæŒ‰é’®
                if (e.target && e.target.id === 'generateBtn') {
                    e.preventDefault();
                    generateDecoration();
                }
            });
            
            // ä¹Ÿå°è¯•ç›´æ¥ç»‘å®šï¼ˆå¦‚æœå…ƒç´ å·²å­˜åœ¨ï¼‰
            setTimeout(() => {
                const undoBtn = document.getElementById('undoBtn');
                const clearBtn = document.getElementById('clearBtn');
                const generateBtn = document.getElementById('generateBtn');
                
                if (undoBtn) {
                    undoBtn.addEventListener('click', undo);
                    console.log('æ’¤é”€æŒ‰é’®äº‹ä»¶å·²ç»‘å®š');
                }
                if (clearBtn) {
                    clearBtn.addEventListener('click', clearCanvas);
                    console.log('æ¸…é™¤æŒ‰é’®äº‹ä»¶å·²ç»‘å®š');
                }
                if (generateBtn) {
                    generateBtn.addEventListener('click', generateDecoration);
                    console.log('ç”ŸæˆæŒ‰é’®äº‹ä»¶å·²ç»‘å®š');
                }
            }, 500);
        }

        // æ£€æŸ¥æ˜¯å¦å¯ä»¥ç”Ÿæˆ
        function checkCanGenerate() {
            const canGenerate = uploadedImageFile && selectedFurniture && drawingHistory.length > 1;
            const generateBtn = document.getElementById('generateBtn');
            if (generateBtn) {
                generateBtn.disabled = !canGenerate;
            }
            
            if (canGenerate) {
                activateStep(6);
            }
        }

        // æ¿€æ´»æ­¥éª¤
        function activateStep(stepNumber) {
            document.querySelectorAll('.step').forEach(step => {
                step.classList.remove('active');
            });
            const targetStep = document.getElementById(`step${stepNumber}`);
            if (targetStep) {
                targetStep.classList.add('active');
                currentStep = stepNumber;
                
                // æ»šåŠ¨åˆ°å½“å‰æ­¥éª¤
                targetStep.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
            }
        }

        // ç”Ÿæˆè£…ä¿®æ•ˆæœå›¾
        function generateDecoration() {
            if (!uploadedImageFile || !selectedFurniture) {
                showMessage('Please complete the previous steps', 'error');
                return;
            }
            
            // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
            const loadingEl = document.getElementById('loading');
            const generateBtn = document.getElementById('generateBtn');
            
            if (loadingEl) {
                loadingEl.classList.add('show');
            }
            if (generateBtn) {
                generateBtn.disabled = true;
            }
            
            // è·å–maskæ•°æ® - ä½¿ç”¨å›ºå®š40%é€æ˜åº¦
            const brushOpacity = 0.4; // å›ºå®š40%é€æ˜åº¦
            
            // åˆ›å»ºä¸€ä¸ªä¸´æ—¶canvasæ¥ç”Ÿæˆå¸¦é€æ˜åº¦çš„mask
            const tempCanvas = document.createElement('canvas');
            tempCanvas.width = maskCanvas.width;
            tempCanvas.height = maskCanvas.height;
            const tempCtx = tempCanvas.getContext('2d');
            
            // åœ¨ä¸´æ—¶canvasä¸Šä»¥å›ºå®š40%é€æ˜åº¦ç»˜åˆ¶mask
            tempCtx.globalAlpha = brushOpacity;
            tempCtx.drawImage(maskCanvas, 0, 0);
            
            // è·å–åº”ç”¨äº†é€æ˜åº¦çš„maskæ•°æ®
            const maskData = tempCanvas.toDataURL('image/png');
            
            console.log(`ä¿å­˜maskæ•°æ®ï¼Œå›ºå®šé€æ˜åº¦è®¾ç½®: 40%`);
            console.log(`Maskæ•°æ®é•¿åº¦: ${maskData.length}`);
            
            // å…ˆä¿å­˜maskå›¾ç‰‡
            fetch('/save_mask', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    original_image: uploadedImageFile,
                    mask_data: maskData
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // è°ƒç”¨ç”ŸæˆAPI
                    return fetch('/generate_v1', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            original_image: uploadedImageFile,
                            selected_furniture: selectedFurniture.name,
                            mask_filename: data.mask_filename
                        })
                    });
                } else {
                    throw new Error(data.error || 'ä¿å­˜maskå¤±è´¥');
                }
            })
            .then(response => response.json())
            .then(data => {
                const loadingEl = document.getElementById('loading');
                const generateBtn = document.getElementById('generateBtn');
                
                if (loadingEl) {
                    loadingEl.classList.remove('show');
                }
                if (generateBtn) {
                    generateBtn.disabled = false;
                }
                
                if (data.success) {
                    displayResults(data.generated_images);
                    showMessage(data.message, 'success');
                } else {
                    showMessage(data.error || 'Generation failed', 'error');
                }
            })
            .catch(error => {
                const loadingEl = document.getElementById('loading');
                const generateBtn = document.getElementById('generateBtn');
                
                if (loadingEl) {
                    loadingEl.classList.remove('show');
                }
                if (generateBtn) {
                    generateBtn.disabled = false;
                }
                showMessage('Generation failed: ' + error.message, 'error');
            });
        }

        // æ˜¾ç¤ºç»“æœ
        function displayResults(images) {
            const container = document.getElementById('resultContainer');
            container.innerHTML = '<h3>ğŸ‰ Generation Successful!</h3>';
            
            images.forEach((image, index) => {
                const imgElement = document.createElement('img');
                imgElement.src = image.path;
                imgElement.className = 'result-image';
                imgElement.style.margin = '20px 10px';
                container.appendChild(imgElement);
                
                // æ·»åŠ ä¸‹è½½é“¾æ¥
                const downloadLink = document.createElement('a');
                downloadLink.href = image.path;
                downloadLink.download = image.filename;
                downloadLink.className = 'btn';
                downloadLink.style.margin = '10px';
                downloadLink.textContent = `Download Image ${index + 1}`;
                container.appendChild(downloadLink);
            });
        }

        // æ˜¾ç¤ºæ¶ˆæ¯
        function showMessage(text, type = 'success') {
            const message = document.getElementById('message');
            message.textContent = text;
            message.className = `message ${type} show`;
            
            setTimeout(() => {
                message.classList.remove('show');
            }, 5000);
        }
    </script>
</body>
</html>