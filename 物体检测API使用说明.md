# 百度物体检测API使用说明

## API端点

**端点**: `https://aip.baidubce.com/rest/2.0/image-classify/v1/object_detect`

**请求方式**: POST

**Content-Type**: `application/x-www-form-urlencoded`

## 功能说明

该API用于检测图片中的物体，返回：
- 物体名称/类型
- 置信度分数
- 物体位置（边界框坐标）

**重要提示**：该API**不直接返回房间尺寸**，只能检测图片中的物体。

## 返回格式示例

```json
{
  "result": [
    {
      "name": "沙发",
      "score": 0.95,
      "location": {
        "left": 100,
        "top": 150,
        "width": 300,
        "height": 200
      }
    },
    {
      "name": "门",
      "score": 0.88,
      "location": {
        "left": 50,
        "top": 0,
        "width": 80,
        "height": 200
      }
    }
  ]
}
```

## 当前实现

代码已经更新为使用该API端点，处理逻辑如下：

1. **调用物体检测API**：检测图片中的物体
2. **提取物体信息**：解析返回的物体列表
3. **尝试获取尺寸**：如果API返回中包含房间尺寸字段，直接使用
4. **降级处理**：如果没有尺寸信息，提示用户手动输入

## 如何获取房间尺寸

由于物体检测API不能直接返回房间尺寸，有以下几种方式：

### 方案1：API直接返回尺寸（如果您的API支持）

如果百度智能云为您提供了自定义模型，API返回可能包含尺寸信息，代码会自动解析。

### 方案2：基于参考物计算（需要额外开发）

1. 检测参考物（门、窗户、已知尺寸的家具等）
2. 用户标注参考物并输入实际尺寸
3. 根据像素比例计算房间尺寸

### 方案3：用户手动输入（当前已实现）

当API无法识别尺寸时，系统会自动提示用户手动输入，这是最可靠的方式。

## 代码修改说明

### 1. API端点已更新

```python
api_url = f"https://aip.baidubce.com/rest/2.0/image-classify/v1/object_detect?access_token={access_token}"
```

### 2. 返回结果处理

代码现在会：
- 解析检测到的物体列表
- 查找可能的参考物（门、窗户、沙发等）
- 尝试从返回结果中提取尺寸信息
- 如果无法提取，返回检测到的物体信息供参考

### 3. 返回数据结构

```python
{
    'success': bool,              # 是否成功识别尺寸
    'length': float,              # 长度（米），如果成功
    'width': float,               # 宽度（米），如果成功
    'detected_objects': [],       # 检测到的物体列表
    'reference_objects': [],      # 可能的参考物列表
    'error': str                  # 错误信息（如果失败）
}
```

## 测试步骤

1. **配置API密钥**
   ```env
   BAIDU_API_KEY=您的API_KEY
   BAIDU_SECRET_KEY=您的SECRET_KEY
   ```

2. **上传客厅图片**
   - 系统会自动调用物体检测API
   - 检测图片中的物体

3. **查看结果**
   - 如果API返回了尺寸信息，会自动显示
   - 如果没有，会提示手动输入，并显示检测到的物体信息

4. **检查日志**
   - 查看 `project_log/project.log` 文件
   - 可以看到完整的API返回结果和检测到的物体列表

## 常见问题

### Q1: API返回了物体，但没有尺寸信息？
**A**: 这是正常的。物体检测API只检测物体，不测量尺寸。如果您的API确实会返回尺寸，请检查返回的JSON格式，我可以调整解析逻辑。

### Q2: 如何让系统自动计算尺寸？
**A**: 需要额外开发基于参考物的计算功能：
1. 让用户选择一个检测到的参考物（如门）
2. 用户输入该参考物的实际尺寸
3. 根据像素比例计算房间尺寸

### Q3: API返回格式不同怎么办？
**A**: 请提供实际的API返回JSON示例，我可以调整代码的解析逻辑。

## 后续优化建议

1. **参考物标注功能**：让用户点击检测到的门/窗户，输入实际尺寸，自动计算房间尺寸
2. **智能推荐**：根据检测到的物体类型和数量，智能推荐可能的房间尺寸范围
3. **图片预处理**：如果图片包含透视变形，可以先校正再检测

## 技术支持

如果API返回格式与代码预期不同，请：
1. 提供实际的API返回JSON示例
2. 检查日志文件中的完整返回结果
3. 我会根据实际情况调整解析逻辑
